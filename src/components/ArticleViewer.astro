---
// ArticleViewer.astro - Reusable article popup viewer component
export interface Props {
  id?: string;
  className?: string;
}

const { id = "article-viewer", className = "" } = Astro.props;
---

<!-- Article Viewer Modal -->
<div id={id} class={`hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center p-2 lg:p-4 ${className}`}
  role="dialog" aria-modal="true" aria-labelledby="viewer-title">
  <div class="bg-white rounded-xl shadow-2xl max-w-7xl w-full max-h-[95vh] lg:max-h-[95vh] overflow-hidden border border-gray-200">
    <div class="p-4 lg:p-6 border-b border-gray-200 bg-gradient-to-r from-amber-50 to-amber-100">
      <div class="flex justify-between items-start">
        <h2 class="text-lg lg:text-2xl font-bold text-gray-900 pr-4" id="viewer-title" tabindex="-1"></h2>
        <button id="close-viewer" class="btn btn-ghost btn-sm text-gray-700 hover:text-gray-900 hover:bg-white/50 rounded-full" aria-label="Close article viewer">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    
            <div class="flex flex-col lg:flex-row h-[calc(95vh-120px)]">
          <!-- Image Panel with Zoom/Pan -->
          <div class="lg:w-1/2 p-3 lg:p-6 lg:border-r border-gray-200 bg-gray-50">
            <div class="relative h-full">
              <!-- Mobile: Fixed height, Desktop: Full height -->
              <div id="image-container" class="relative w-full h-64 lg:h-full overflow-hidden bg-white border-2 border-gray-200 rounded-lg shadow-inner">
                <img id="viewer-image" class="w-full h-full object-contain transition-transform duration-200" alt="" loading="eager" decoding="async" />
                <div id="image-loading" class="absolute inset-0 bg-gray-100 rounded-lg flex items-center justify-center">
                  <div class="loading loading-spinner loading-lg text-amber-600"></div>
                </div>
                <div id="image-error" class="hidden absolute inset-0 bg-gray-100 rounded-lg flex items-center justify-center">
                  <div class="text-center text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <p class="text-sm">Image not available</p>
                  </div>
                </div>
              </div>
              
              <!-- Zoom Controls -->
              <div class="absolute top-4 left-4 flex flex-col gap-2 rounded-lg p-2 bg-white/95 backdrop-blur-sm shadow-lg border border-gray-200">
                <button id="zoom-in" class="btn btn-circle btn-sm bg-amber-500 hover:bg-amber-600 text-white border-0" title="Zoom In (Click)" aria-label="Zoom in on article image">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                  </svg>
                </button>
                <button id="zoom-out" class="btn btn-circle btn-sm bg-amber-500 hover:bg-amber-600 text-white border-0" title="Zoom Out (Shift+Click or Right Click)" aria-label="Zoom out of article image">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10h-6"></path>
                  </svg>
                </button>
                <button id="reset-zoom" class="btn btn-circle btn-sm bg-gray-200 hover:bg-gray-300 text-gray-700 border-0" title="Reset Zoom" aria-label="Reset image zoom and pan">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Transcript Panel -->
          <div class="lg:w-1/2 p-3 lg:p-6 flex flex-col bg-gray-50 min-h-0">
            <!-- Mobile: Scrollable transcript area, Desktop: Full height -->
            <div class="flex-1 overflow-hidden min-h-0 mb-4">
              <h3 class="text-lg font-semibold mb-3 text-gray-900">Transcription</h3>
              <div id="viewer-transcription" class="h-64 lg:h-full overflow-y-auto border-2 border-gray-200 rounded-lg p-4 lg:p-6 bg-white text-sm"></div>
            </div>
            
            <!-- Citation - Always at bottom -->
            <div class="flex-shrink-0 p-4 bg-amber-50 border border-amber-200 rounded-lg">
              <h4 class="text-sm font-semibold mb-2 text-gray-900">Citation</h4>
              <p class="text-xs text-gray-700 leading-relaxed" id="viewer-citation"></p>
            </div>
          </div>
        </div>
  </div>
</div>

<script>
  // Global type declarations
  declare global {
    interface Window {
      articleViewer: ArticleViewer;
    }
  }

  // Focus trap and accessibility helpers
  function getFocusableElements(container: HTMLElement): HTMLElement[] {
    return Array.from(container.querySelectorAll(
      'a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])'
    ));
  }

  // Article Viewer functionality
  class ArticleViewer {
    private container: HTMLElement | null;
    private image: HTMLImageElement | null;
    private title: HTMLElement | null;
    private transcription: HTMLElement | null;
    private citation: HTMLElement | null;
    private closeBtn: HTMLElement | null;
    private zoomInBtn: HTMLElement | null;
    private zoomOutBtn: HTMLElement | null;
    private resetZoomBtn: HTMLElement | null;
    private imageContainer: HTMLElement | null;
    private imageLoading: HTMLElement | null;
    private imageError: HTMLElement | null;
    private lastActiveElement: Element | null;
    private currentScale: number;
    private isDragging: boolean;
    private dragStart: { x: number; y: number };
    private currentTranslate: { x: number; y: number };

    constructor(containerId = 'article-viewer') {
      this.container = document.getElementById(containerId);
      this.image = document.getElementById('viewer-image') as HTMLImageElement;
      this.title = document.getElementById('viewer-title');
      this.transcription = document.getElementById('viewer-transcription');
      this.citation = document.getElementById('viewer-citation');
      this.closeBtn = document.getElementById('close-viewer');
      this.zoomInBtn = document.getElementById('zoom-in');
      this.zoomOutBtn = document.getElementById('zoom-out');
      this.resetZoomBtn = document.getElementById('reset-zoom');
      this.imageContainer = document.getElementById('image-container');
      this.imageLoading = document.getElementById('image-loading');
      this.imageError = document.getElementById('image-error');
      this.lastActiveElement = null;
      this.currentScale = 1;
      this.isDragging = false;
      this.dragStart = { x: 0, y: 0 };
      this.currentTranslate = { x: 0, y: 0 };
      this.init();
    }
    
    init() {
      // Close modal
      this.closeBtn?.addEventListener('click', () => this.close());
      // Close on backdrop click
      this.container?.addEventListener('click', (e) => {
        if (e.target === this.container) this.close();
      });
      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !this.container.classList.contains('hidden')) this.close();
        // Focus trap
        if (!this.container.classList.contains('hidden') && (e.key === 'Tab' || e.keyCode === 9)) {
          this.trapFocus(e);
        }
      });
      // Zoom controls
      this.zoomInBtn?.addEventListener('click', () => this.zoomIn());
      this.zoomOutBtn?.addEventListener('click', () => this.zoomOut());
      this.resetZoomBtn?.addEventListener('click', () => this.resetZoom());
      // Image panning
      this.setupImagePanning();
    }

    trapFocus(e: KeyboardEvent) {
      const focusableEls = getFocusableElements(this.container!);
      if (!focusableEls.length) return;
      const firstEl = focusableEls[0];
      const lastEl = focusableEls[focusableEls.length - 1];
      const isTab = e.key === 'Tab' || e.keyCode === 9;
      if (!isTab) return;
      if (e.shiftKey) {
        if (document.activeElement === firstEl) {
          e.preventDefault();
          lastEl.focus();
        }
      } else {
        if (document.activeElement === lastEl) {
          e.preventDefault();
          firstEl.focus();
        }
      }
    }
    
    setupImagePanning() {
      if (!this.image) return;
      
      // Mouse events
      this.image.addEventListener('mousedown', (e) => this.startDrag(e));
      document.addEventListener('mousemove', (e) => this.drag(e));
      document.addEventListener('mouseup', () => this.endDrag());
      
      // Touch events for mobile
      this.image.addEventListener('touchstart', (e) => this.startDrag(e));
      document.addEventListener('touchmove', (e) => this.drag(e));
      document.addEventListener('touchend', () => this.endDrag());
      
      // Zoom on click
      this.image.addEventListener('click', (e) => {
        if (e.shiftKey) {
          this.zoomOut();
        } else {
          this.zoomIn();
        }
      });
      
      // Right click to zoom out
      this.image.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        this.zoomOut();
      });
    }
    
    startDrag(e: MouseEvent | TouchEvent) {
      if (this.currentScale <= 1) return;
      
      this.isDragging = true;
      const point = e instanceof TouchEvent ? e.touches[0] : e;
      this.dragStart = { x: point.clientX, y: point.clientY };
    }
    
    drag(e: MouseEvent | TouchEvent) {
      if (!this.isDragging) return;
      
      e.preventDefault();
      const point = e instanceof TouchEvent ? e.touches[0] : e;
      const deltaX = point.clientX - this.dragStart.x;
      const deltaY = point.clientY - this.dragStart.y;
      
      this.currentTranslate.x += deltaX;
      this.currentTranslate.y += deltaY;
      
      this.updateImageTransform();
      this.dragStart = { x: point.clientX, y: point.clientY };
    }
    
    endDrag() {
      this.isDragging = false;
    }
    
    updateImageTransform() {
      if (!this.image) return;
      
      this.image.style.transform = `scale(${this.currentScale}) translate(${this.currentTranslate.x / this.currentScale}px, ${this.currentTranslate.y / this.currentScale}px)`;
    }
    
    zoomIn() {
      this.currentScale = Math.min(this.currentScale * 1.5, 5);
      this.updateImageTransform();
    }
    
    zoomOut() {
      this.currentScale = Math.max(this.currentScale / 1.5, 0.5);
      this.updateImageTransform();
    }
    
    resetZoom() {
      this.currentScale = 1;
      this.currentTranslate = { x: 0, y: 0 };
      this.updateImageTransform();
    }
    
    show(articleData: { title?: string; transcription?: string; citation?: string; imageUrl?: string }) {
      if (!this.container) return;
      // Store last focused element
      this.lastActiveElement = document.activeElement;
      // Set content
      if (this.title) this.title.textContent = articleData.title || 'Article';
      if (this.transcription) this.transcription.innerHTML = articleData.transcription || 'No transcription available';
      if (this.citation) this.citation.textContent = articleData.citation || 'Citation not available';
      // Load image
      this.loadImage(articleData.imageUrl);
      // Show modal
      this.container.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      // Reset zoom
      this.resetZoom();
      // Focus the modal title (or close button)
      setTimeout(() => {
        const focusableEls = getFocusableElements(this.container!);
        if (focusableEls.length) {
          (focusableEls[0] as HTMLElement).focus();
        } else if (this.title) {
          this.title.focus();
        }
      }, 0);
    }
    
    loadImage(imageUrl?: string) {
      if (!this.image || !imageUrl) {
        this.showImageError();
        return;
      }
      
      this.showImageLoading();
      
      const img = new Image();
      img.onload = () => {
        if (this.image) {
          this.image.src = imageUrl;
          // Update alt text with article title
          const articleTitle = this.title?.textContent || 'Article';
          this.image.alt = `Newspaper article image: ${articleTitle}`;
        }
        this.hideImageLoading();
        this.hideImageError();
      };
      
      img.onerror = () => {
        this.showImageError();
        this.hideImageLoading();
      };
      
      img.src = imageUrl;
    }
    
    showImageLoading() {
      this.imageLoading?.classList.remove('hidden');
      this.imageError?.classList.add('hidden');
    }
    
    hideImageLoading() {
      this.imageLoading?.classList.add('hidden');
    }
    
    showImageError() {
      this.imageError?.classList.remove('hidden');
      this.imageLoading?.classList.add('hidden');
    }
    
    hideImageError() {
      this.imageError?.classList.add('hidden');
    }
    
    close() {
      if (!this.container) return;
      
      this.container.classList.add('hidden');
      document.body.style.overflow = '';
      // Restore focus to last active element
      if (this.lastActiveElement && typeof this.lastActiveElement.focus === 'function') {
        setTimeout(() => this.lastActiveElement.focus(), 0);
      }
    }
  }
  
  // Initialize the article viewer
  const articleViewer = new ArticleViewer();
  
  // Make it globally available for other scripts
  window.articleViewer = articleViewer;
</script>

<style>
  #viewer-transcription p {
    margin-bottom: 1.25rem;
    text-indent: 0;
    line-height: 1.5;
  }
  
  #viewer-transcription p:last-child {
    margin-bottom: 0;
  }
  
  #viewer-image {
    cursor: grab;
  }
  
  #viewer-image:active {
    cursor: grabbing;
  }
</style> 