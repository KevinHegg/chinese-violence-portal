---
import PageLayout from "../layouts/PageLayout.astro";
import "../styles/western-colors.css";
---

<PageLayout title="Dataset" currentPage="dataset">
  <head>
    <meta name="description" content="Browse and download a living dataset of anti-Chinese violence (1850–1915) compiled from newspapers and archival sources. Sort, filter, and export records of lynchings, massacres, and exclusion events for research and education.">
  </head>
  <div class="container-standard">
    <h1 class="text-4xl font-bold mb-6">Anti-Chinese Lynching Dataset</h1>
    <!-- Callout for Submit Form -->
    <div class="mb-6">
      <div class="bg-amber-100 border-l-4 border-amber-400 rounded-lg p-4 flex flex-col md:flex-row md:items-center gap-3 shadow-sm">
        <div class="flex-1 text-amber-900 text-base">
          <strong>Submit details about acts of lethal violence targeting Chinese immigrants in the U.S. between 1850 and World War I.</strong>
        </div>
        <a href="/submit" class="inline-block mt-2 md:mt-0 px-4 py-2 bg-amber-400 hover:bg-amber-500 text-amber-900 font-semibold rounded shadow transition-colors duration-150 text-sm text-center">Submit an Incident</a>
      </div>
    </div>
    
    <div class="mb-0">
      <p class="text-lg mb-4">
        Explore a living dataset of anti-Chinese violence (1850 – 1915) drawn from newspapers and other archival sources. The table refreshes automatically whenever our Google Sheet is updated. 
        <strong>Click</strong> any column header to sort the table. <strong>Click</strong> the same header again to sort in reverse order. The "[Full record]" link opens a web page with more details about the selected event.
      </p>
      
      <div class="flex flex-wrap gap-4 mb-0">
        <button id="download-csv" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded font-medium shadow-sm hover:shadow-md transition-all duration-200">
          Download CSV
        </button>
        <button id="download-excel" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded font-medium shadow-sm hover:shadow-md transition-all duration-200">
          Download Excel
        </button>
        <button id="download-pdf" class="bg-amber-800 hover:bg-amber-900 text-white px-4 py-2 rounded font-medium shadow-sm hover:shadow-md transition-all duration-200">
          Download PDF
        </button>
      </div>
    </div>

    <div class="dataset-table-wrapper" style="max-height: 800px; overflow: hidden;">
      <div id="table-scroll-top" class="table-scroll-top" role="scrollbar" aria-label="Horizontal scroll (synced with table)"><div id="table-scroll-top-inner"></div></div>
      <div id="table-scroll-main" class="table-scroll" style="overflow-x: scroll; overflow-y: scroll; max-height: 760px; background: #f8fafc; border-radius: 0.5rem; border: 2px solid #d1d5db;">
              <table id="data-table" class="table-layout-fixed text-sm dataset-table">
        <colgroup>
          <col class="col-date">
          <col class="col-newspaper">
          <col class="col-location">
          <col class="col-page">
          <col class="col-state">
          <col class="col-county">
          <col class="col-city">
          <col class="col-event-type">
          <col class="col-victims">
          <col class="col-accusation">
          <col class="col-killing-method">
          <col class="col-compiled-by">
          <col class="col-narrative">
          <col class="col-notes">
          <col class="col-full-text">
        </colgroup>
          <thead>
            <tr class="bg-gray-200">
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="Identifier">ID</th>
              <th class="px-2 py-2 text-left text-sm">Link</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="Name">Name</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="Gender">Gender</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="Date">Date</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="Year">Year</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="Number of Victims">Victims</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="State">State/Terr.</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="County">County</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="City">City</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="Category of Violence">Category of Violence</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="Accusation or Pretext">Accusation</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="Job">Job</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm" data-sort="Killing Method">Killing Method</th>
              <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-300 text-sm col-compiled-by-th" data-sort="Compiled By">Compiled By</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr>
              <td colspan="15" class="text-left py-8 px-4">Loading data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</PageLayout>

<!-- Add html2pdf for better PDF generation - loaded on demand -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- Add xlsx library for Excel file generation - loaded on demand -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  // CSV URL from Google Sheets
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRNUFmt4rj08UFlhScGPJfiOTLPWS_HlT2eRukzdhTq24U2Y877iFBiyTWwHiG7OpHUsMich6giiluS/pub?gid=378919265&single=true&output=csv';

  let tableData: Record<string, string>[] = [];
  let currentSort = { column: 'Year', direction: 'asc' };

  // Parse CSV with quoted fields (handles commas and newlines inside "...")
  function parseCSV(csvText: string): string[][] {
    const rows: string[][] = [];
    let row: string[] = [];
    let field = '';
    let inQuotes = false;
    const len = csvText.length;
    for (let i = 0; i < len; i++) {
      const c = csvText[i];
      const next = csvText[i + 1];
      if (inQuotes) {
        if (c === '"') {
          if (next === '"') {
            field += '"';
            i++;
          } else {
            inQuotes = false;
          }
        } else {
          field += c;
        }
      } else {
        if (c === '"') {
          inQuotes = true;
        } else if (c === ',') {
          row.push(field.trim());
          field = '';
        } else if (c === '\n') {
          row.push(field.trim());
          field = '';
          if (row.some(cell => cell.length > 0)) rows.push(row);
          row = [];
        } else if (c !== '\r') {
          field += c;
        }
      }
    }
    if (field.length > 0 || row.length > 0) {
      row.push(field.trim());
      if (row.some(cell => cell.length > 0)) rows.push(row);
    }
    return rows;
  }

  // Load and parse CSV data
  async function loadData() {
    try {
      const response = await fetch(CSV_URL);
      const csvText = await response.text();
      
      const rows = parseCSV(csvText);
      if (rows.length < 2) {
        throw new Error('Invalid CSV format');
      }
      
      const headers = rows[0].map(h => h.trim());
      const data: Record<string, string>[] = [];
      for (let i = 1; i < rows.length; i++) {
        const values = rows[i];
        const row: Record<string, string> = {};
        headers.forEach((header, index) => {
          row[header] = (values[index] ?? '').trim();
        });
        if (Object.values(row).some(v => v.length > 0)) {
          data.push(row);
        }
      }
      
      tableData = data;
      
      // Initial sort and display
      sortData(currentSort.column, currentSort.direction);
      displayData();
      syncTableScrollWidth();
      
    } catch (error) {
      // Only log errors in development
      if (import.meta.env.DEV) {
        console.error('Error loading data:', error);
      }
      const tableBody = document.getElementById('table-body');
      if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="15" class="text-center py-8 text-red-600">Error loading data. Please try again.</td></tr>';
      }
    }
  }

  // Sort data
  function sortData(column: string, direction: 'asc' | 'desc') {
    tableData.sort((a, b) => {
      let aVal = a[column] || '';
      let bVal = b[column] || '';
      
      // Handle numeric columns
      if (column === 'Year' || column === 'Number of Victims') {
        aVal = parseInt(aVal) || 0;
        bVal = parseInt(bVal) || 0;
      }
      
      if (direction === 'asc') {
        return aVal > bVal ? 1 : -1;
      } else {
        return aVal < bVal ? 1 : -1;
      }
    });
  }

  // Display data in table
  function displayData() {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    
    tableData.forEach((row, index) => {
      const tr = document.createElement('tr');
      // Add alternating row background
      if (index % 2 === 0) {
        tr.className = 'hover:bg-gray-50 bg-white';
      } else {
        tr.className = 'hover:bg-gray-50 bg-gray-50';
      }
      
      const compiledBy = row['Compiled By'] || '';
      tr.innerHTML = `
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['Identifier'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm">
          ${row['Link'] ? `<a href="${row['Link']}" target="_blank" class="text-blue-600 hover:underline text-sm">[Full record]</a>` : ''}
        </td>
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['Name'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['Gender'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['Date'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['Year'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['Number of Victims'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['State'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['County'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['City'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['Category of Violence'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['Accusation or Pretext'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['Job'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm">${row['Killing Method'] || row['Killing method'] || row['killing-method'] || ''}</td>
        <td class="border border-gray-300 px-2 py-2 text-sm cell-compiled-by">${compiledBy}</td>
      `;
      
      tbody.appendChild(tr);
    });
    syncTableScrollWidth();
  }

  // Keep top horizontal scrollbar in sync with table width and scroll position
  function syncTableScrollWidth() {
    const table = document.getElementById('data-table');
    const topInner = document.getElementById('table-scroll-top-inner');
    const topScroll = document.getElementById('table-scroll-top');
    const mainScroll = document.getElementById('table-scroll-main');
    if (!table || !topInner || !topScroll || !mainScroll) return;
    const w = table.scrollWidth;
    topInner.style.width = w + 'px';
    topInner.style.height = '1px';
  }
  function setupTopScrollSync() {
    const topScroll = document.getElementById('table-scroll-top');
    const mainScroll = document.getElementById('table-scroll-main');
    if (!topScroll || !mainScroll) return;
    topScroll.addEventListener('scroll', () => { mainScroll.scrollLeft = topScroll.scrollLeft; });
    mainScroll.addEventListener('scroll', () => { topScroll.scrollLeft = mainScroll.scrollLeft; });
  }

  // Handle column sorting
  function setupSorting() {
    const headers = document.querySelectorAll('th[data-sort]');
    headers.forEach(header => {
      header.addEventListener('click', () => {
        const column = header.getAttribute('data-sort');
        const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
        
        currentSort = { column, direction };
        sortData(column, direction);
        displayData();
        
        // Update header styling
        headers.forEach(h => h.classList.remove('bg-blue-200'));
        header.classList.add('bg-blue-200');
      });
    });
  }

  // Download functions
  function downloadCSV() {
    if (tableData.length === 0) {
      alert('No data available for download');
      return;
    }
    
    const headers = Object.keys(tableData[0]);
    const csvContent = [
      headers.join(','),
      ...tableData.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'chinese-violence-dataset.csv';
    a.click();
    window.URL.revokeObjectURL(url);
  }

  function downloadExcel() {
    if (tableData.length === 0) {
      alert('No data available for download');
      return;
    }
    
    const worksheet = XLSX.utils.json_to_sheet(tableData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
    
    const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'chinese-violence-dataset.xlsx';
    a.click();
    window.URL.revokeObjectURL(url);
  }

  function downloadPDF() {
    if (tableData.length === 0) {
      alert('No data available for download');
      return;
    }
    
    try {
      // Create a temporary container for the PDF
      const pdfContainer = document.createElement('div');
      pdfContainer.style.padding = '20px';
      pdfContainer.style.fontFamily = 'Arial, sans-serif';
      
      // Add title
      const title = document.createElement('h1');
      title.textContent = 'Chinese Violence Dataset (1850-1915)';
      title.style.fontSize = '18px';
      title.style.marginBottom = '10px';
      title.style.color = '#333';
      pdfContainer.appendChild(title);
      
      // Add date
      const date = document.createElement('p');
      date.textContent = 'Generated on: ' + new Date().toLocaleDateString();
      date.style.fontSize = '12px';
      date.style.marginBottom = '20px';
      date.style.color = '#666';
      pdfContainer.appendChild(date);
      
      // Clone the table for PDF
      const table = document.getElementById('data-table').cloneNode(true);
      table.style.fontSize = '8px';
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      
      // Style the table for PDF
      const cells = table.querySelectorAll('th, td');
      cells.forEach(cell => {
        cell.style.border = '1px solid #ccc';
        cell.style.padding = '2px 4px';
        cell.style.fontSize = '8px';
      });
      
      // Style headers
      const headers = table.querySelectorAll('th');
      headers.forEach(header => {
        header.style.backgroundColor = '#f0f0f0';
        header.style.fontWeight = 'bold';
      });
      
      pdfContainer.appendChild(table);
      
      // Configure html2pdf options
      const opt = {
        margin: [10, 10, 10, 10],
        filename: 'chinese-violence-dataset.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2,
          useCORS: true,
          letterRendering: true
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'landscape' 
        }
      };
      
      // Generate PDF
      html2pdf().set(opt).from(pdfContainer).save();
      
    } catch (error) {
      if (import.meta.env.DEV) {
        console.error('PDF generation error:', error);
      }
      alert('PDF export failed: ' + error.message + '. Please try again.');
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    loadData();
    setupSorting();
    setupTopScrollSync();
    
    // Setup download buttons
    document.getElementById('download-csv').addEventListener('click', downloadCSV);
    document.getElementById('download-excel').addEventListener('click', downloadExcel);
    document.getElementById('download-pdf').addEventListener('click', downloadPDF);
  });
</script> 

<style>
/* Table uses column widths and overflows for horizontal scroll */
.dataset-table {
  width: max-content;
  min-width: 100%;
}
.col-compiled-by-th,
.cell-compiled-by {
  min-width: 360px;
  width: 360px;
  max-width: 360px;
}

/* Top horizontal scroll (synced with main table scroll) */
.table-scroll-top {
  overflow-x: scroll;
  overflow-y: hidden;
  height: 24px;
  margin-bottom: 4px;
  scrollbar-gutter: stable;
  scrollbar-width: auto;
  scrollbar-color: #64748b #e5e7eb;
}
.table-scroll-top::-webkit-scrollbar {
  height: 14px;
  background: #e5e7eb;
  border-radius: 0.5rem;
}
.table-scroll-top::-webkit-scrollbar-thumb {
  background: #64748b;
  border-radius: 0.5rem;
}
.table-scroll-top::-webkit-scrollbar-thumb:hover {
  background: #334155;
}
#table-scroll-top-inner {
  height: 1px;
  pointer-events: none;
}

.table-scroll {
  scrollbar-width: auto;
  scrollbar-color: #64748b #e5e7eb;
  border-radius: 0.5rem;
}
.table-scroll::-webkit-scrollbar {
  height: 14px;
  width: 14px;
  background: #e5e7eb;
  border-radius: 0.5rem;
}
.table-scroll::-webkit-scrollbar-thumb {
  background: #64748b;
  border-radius: 0.5rem;
}
.table-scroll::-webkit-scrollbar-thumb:hover {
  background: #334155;
}
th, td {
  border: 1px solid #cbd5e1;
  background-clip: padding-box;
}
th {
  background-color: #e5e7eb;
  font-weight: bold;
}
.bg-gray-50 {
  background-color: #f8fafc;
}
</style> 