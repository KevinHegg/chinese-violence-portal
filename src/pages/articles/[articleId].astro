---
import PageLayout from "../../layouts/PageLayout.astro";
import { fetchArticlesData, fetchLynchingsData } from "../../utils/googleSheets";

export const prerender = false;

// Fetch articles and lynchings data
const [articles, lynchingsData] = await Promise.all([
  fetchArticlesData(),
  fetchLynchingsData()
]);

const { articleId } = Astro.params;
const article = articles.find((a: any) => a["article-id"] === articleId);

if (!article) {
  return Astro.redirect('/404');
}

// Find related lynching records that reference this article
const relatedRecords = lynchingsData.filter((l: any) => {
  const articleIds = l["article-ids"];
  if (!articleIds || !Array.isArray(articleIds)) return false;
  return articleIds.includes(articleId);
});

// Format date helper
const formatDate = (dateStr: string) => {
  if (!dateStr) return "Unknown";
  const [year, month, day] = dateStr.split("-");
  if (!year) return dateStr;
  if (month === "00" || !month) return year;
  const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];
  const monthIndex = parseInt(month, 10) - 1;
  if (isNaN(monthIndex) || monthIndex < 0 || monthIndex > 11) return year;
  const monthName = monthNames[monthIndex];
  if (day === "00" || !day) return `${monthName} ${year}`;
  return `${monthName} ${parseInt(day, 10)}, ${year}`;
};
---

<PageLayout title={article["article-title"] || "Article Not Found"} currentPage="articles">
      <div class="container-standard mt-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="Breadcrumb" class="mb-4">
      <ol class="flex items-center text-sm text-gray-600 flex-wrap">
        <li class="flex items-center">
          <a href="/" class="hover:text-accent transition-colors">Home</a>
          <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </li>
        <li class="flex items-center">
          <a href="/visualize/news" class="hover:text-accent transition-colors">News Articles</a>
          <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </li>
        <li class="text-gray-500 font-medium truncate max-w-xs" aria-current="page">
          {article["article-title"] || "Article"}
        </li>
      </ol>
    </nav>
  </div>
      <div class="container-standard border border-gray-200 shadow-sm overflow-hidden bg-amber-50 rounded-lg">
    <!-- Header -->
    <div class="border-b border-amber-200 py-2" style="background-color: #fffbe6;">
      <h1 class="text-3xl font-bold text-gray-900 mb-1" style="padding-left: 21px;">{article["article-title"] || "Article Not Found"}</h1>
    </div>

    <!-- Metadata and Thumbnail -->
    <div class="px-10 p-6 border-b border-gray-200 bg-white flex gap-6 items-start justify-between" style="padding-left: 20px;">
      <!-- Metadata Table -->
      <div class="flex-1 max-w-xs">
        <table class="w-full text-left align-top" style="border-spacing:0;border-collapse:collapse;" aria-label="Article metadata">
          <tbody>
                    <tr class="table-row"><th class="table-header" scope="row">Newspaper:</th><td class="table-cell">{article["newspaper"] || "Unknown"}</td></tr>
        <tr class="table-row"><th class="table-header" scope="row">Publication&nbsp;Date:&nbsp;&nbsp;&nbsp;</th><td class="table-cell">{article["publication-date-expanded"] || "Unknown"}</td></tr>
        <tr class="table-row"><th class="table-header" scope="row">Published at:</th><td class="table-cell">{article["newspaper-location"] || "Unknown"}</td></tr>
        <tr><th class="table-header" scope="row">Page Number:</th><td class="table-cell">{article["page"] || "Unknown"}</td></tr>
          </tbody>
        </table>
      </div>
      <!-- Thumbnail -->
      <div class="flex-shrink-0 flex items-start justify-end w-[200px]" style="margin-left:auto;">
        {article["image_name"] ? (
          <img 
            src={`/article-scans/${article["image_name"]}`} 
            alt={`Newspaper article thumbnail: ${article["article-title"] || "article"} from ${article.newspaper || "newspaper"}, ${article["publication-date"] || ""}`}
            class="w-[200px] h-[200px] object-cover rounded-lg border border-gray-200 cursor-pointer"
            id="article-thumbnail"
            style="width:200px;height:200px;"
            loading="lazy"
            decoding="async"
            onerror="this.style.display='none'"
          />
        ) : (
          <div class="w-[200px] h-[200px] bg-gray-200 rounded-lg border border-gray-300 flex items-center justify-center text-gray-500 text-sm">
            No Image Available
          </div>
        )}
      </div>
    </div>

    <!-- Article Transcript -->
    <div class="p-6 border-b border-gray-200" style="background-color: #faf9f6;">
      <h2 class="text-xl font-semibold mb-4">Article Transcript</h2>
      <div class="prose max-w-none w-full">
        {article["article-transcript"] ? 
          article["article-transcript"]
            .split('⏎')
            .map(p => p.trim())
            .filter(p => p.length > 0)
            .map((p) => (
              <p style="text-indent: 1.5em; margin-bottom: 0.5em; margin-top: 0.3em">{p}</p>
            ))
          : <p>Transcript not available</p>
        }
      </div>
    </div>

    <!-- Citation -->
    <div class="p-6 bg-white border-b border-gray-200">
      <h2 class="text-xl font-semibold mb-4">Citation</h2>
      <div class="text-sm text-gray-700">{article["turabian-citation"] || "Citation not available"}</div>
    </div>

    <!-- Related Records -->
    {relatedRecords.length > 0 && (
      <div class="p-6 bg-amber-50">
        <h2 class="text-xl font-semibold mb-4">Related Lynching Records</h2>
        <p class="text-sm text-gray-600 mb-4">This article is referenced in the following records:</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {relatedRecords.map((record: any) => (
            <a href={`/records/${record["lynching-id"]}`} class="block bg-white border border-amber-200 rounded-lg p-4 hover:shadow-md transition-shadow">
              <div class="flex justify-between items-start mb-2">
                <h3 class="font-semibold text-gray-900 flex-1">{record["narrative-short-title"]}</h3>
                <span class="text-xs text-gray-500 ml-2">{formatDate(record["date"])}</span>
              </div>
              <p class="text-sm text-gray-600 mb-2">
                {record["city"] ? `${record["city"]}, ` : ''}{record["state"]} • {record["event-type"]}
              </p>
              <span class="text-sm text-accent hover:text-accent-focus">View full record →</span>
            </a>
          ))}
        </div>
      </div>
    )}
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex flex-col items-center justify-center p-2 lg:p-4">
    <div class="flex justify-end w-full max-w-4xl mb-2">
      <button id="zoom-in" class="mx-1 px-3 py-1 bg-white rounded shadow text-lg font-bold">+</button>
      <button id="zoom-out" class="mx-1 px-3 py-1 bg-white rounded shadow text-lg font-bold">-</button>
      <button id="close-lightbox" class="mx-1 px-3 py-1 bg-white rounded shadow text-lg font-bold">×</button>
    </div>
    <div class="overflow-y-auto flex-1 w-full flex justify-center items-center" style="max-height:80vh;">
      <img id="lightbox-image" class="rounded-lg shadow-xl transition-all duration-200" alt="" style="max-width:100%; max-height:none; width:auto; height:auto;" />
    </div>
  </div>

  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      const thumbnail = document.getElementById('article-thumbnail');
      const modal = document.getElementById('lightbox-modal');
      const lightboxImage = document.getElementById('lightbox-image');
      const zoomInBtn = document.getElementById('zoom-in');
      const zoomOutBtn = document.getElementById('zoom-out');
      const closeBtn = document.getElementById('close-lightbox');
      
      // Check if all required elements exist before proceeding
      if (!thumbnail || !modal || !lightboxImage || !zoomInBtn || !zoomOutBtn || !closeBtn) {
        if (import.meta.env.DEV) {
          console.warn('Some lightbox elements not found, lightbox functionality disabled');
        }
        return;
      }
      
      let zoom = 1;
      function setZoom(newZoom) {
        zoom = Math.max(0.2, Math.min(newZoom, 5));
        lightboxImage.style.transform = `scale(${zoom})`;
      }
      
      // Only add click handler if thumbnail exists and has a valid src
      if (thumbnail.src && thumbnail.src !== window.location.href) {
        thumbnail.addEventListener('click', function() {
          lightboxImage.src = thumbnail.src;
          lightboxImage.alt = thumbnail.alt || `Full size image of newspaper article: ${document.querySelector('h1')?.textContent || 'article'}`;
          setZoom(1);
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        });
      }
      
      zoomInBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        setZoom(zoom + 0.2);
      });
      
      zoomOutBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        setZoom(zoom - 0.2);
      });
      
      closeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        lightboxImage.src = '';
      });
      
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto';
          lightboxImage.src = '';
        }
      });
      
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto';
          lightboxImage.src = '';
        }
      });
    });
  </script>

  <style>
    .bg-yellow-header {
      background-color: #fffbe6;
    }
    .prose {
      font-family: inherit;
      font-size: 1rem;
      line-height: 1.6;
    }
    .prose p {
      margin-bottom: 0.5em !important;
    }
    #lightbox-modal .overflow-y-auto {
      max-height: 80vh;
    }
    #lightbox-image {
      display: block;
      margin: 0 auto;
      transition: transform 0.2s;
    }
    #zoom-in, #zoom-out, #close-lightbox {
      cursor: pointer;
      border: none;
      outline: none;
    }
  </style>
</PageLayout> 