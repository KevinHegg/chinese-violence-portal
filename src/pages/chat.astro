---
import PageLayout from "../layouts/PageLayout.astro";
---

<PageLayout title="Ask the Archive" currentPage="chat">
  <style>
    .chat-message a {
      color: #2563eb;
      text-decoration: underline;
      font-weight: 500;
    }
    .chat-message a:hover {
      color: #1d4ed8;
      text-decoration: none;
    }
    .chat-message a:visited {
      color: #7c3aed;
    }
    
    /* Markdown styling */
    .chat-message h1, .chat-message h2, .chat-message h3, .chat-message h4, .chat-message h5, .chat-message h6 {
      font-weight: 600;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    .chat-message h1 { font-size: 1.5rem; }
    .chat-message h2 { font-size: 1.25rem; }
    .chat-message h3 { font-size: 1.125rem; }
    
    .chat-message p {
      margin-bottom: 0.75rem;
    }
    
    .chat-message ul, .chat-message ol {
      margin-left: 1.5rem;
      margin-bottom: 0.75rem;
    }
    
    .chat-message li {
      margin-bottom: 0.25rem;
    }
    
    .chat-message strong, .chat-message b {
      font-weight: 600;
    }
    
    .chat-message em, .chat-message i {
      font-style: italic;
    }
    
    .chat-message blockquote {
      border-left: 3px solid #e5e7eb;
      padding-left: 1rem;
      margin: 1rem 0;
      font-style: italic;
      color: #6b7280;
    }
    
    .chat-message code {
      background-color: #f3f4f6;
      padding: 0.125rem 0.25rem;
      border-radius: 0.25rem;
      font-family: monospace;
      font-size: 0.875rem;
    }
    
    .chat-message pre {
      background-color: #f3f4f6;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      margin: 1rem 0;
    }
    
    .chat-message pre code {
      background: none;
      padding: 0;
    }
  </style>
  <div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold mb-6">Ask the Archive</h1>
    
    <p class="mb-8 text-lg">
      Hello! I'm your research assistant for the Chinese Violence Portal. I can help you explore the database of lynchings, riots, and other acts of violence against Chinese immigrants in 19th century America. This Chat is very experimental and may return inaccurate information so please verify its responses. Four <strong>clickable</strong> conversation starters are provided below.
    </p>

    <!-- Conversation Starters -->
    <div class="mb-8">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
        <button 
          class="conversation-starter block group rounded-xl shadow-vintage border border-amber-200 p-3 hover:shadow-lg transition-all duration-200 bg-white w-full text-left"
          data-message="Give the 10 largest anti-Chinese mob actions in California, 1870-1890, with dates and links."
        >
          <div class="flex items-center mb-2">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-amber-100 text-amber-700 mr-2">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
              </svg>
            </span>
            <span class="font-display font-semibold text-sm">California Mob Actions</span>
          </div>
          <p class="text-xs text-gray-600">The 10 largest anti-Chinese mob actions in California, 1870-1890, with dates and links.</p>
        </button>

        <button 
          class="conversation-starter block group rounded-xl shadow-vintage border border-amber-200 p-3 hover:shadow-lg transition-all duration-200 bg-white w-full text-left"
          data-message="Show me local newspaper reports on the 1885 Rock Springs massacre."
        >
          <div class="flex items-center mb-2">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-amber-100 text-amber-700 mr-2">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
              </svg>
            </span>
            <span class="font-display font-semibold text-sm">Rock Springs Massacre</span>
          </div>
          <p class="text-xs text-gray-600">Local newspaper reports on the 1885 Rock Springs massacre.</p>
        </button>

        <button 
          class="conversation-starter block group rounded-xl shadow-vintage border border-amber-200 p-3 hover:shadow-lg transition-all duration-200 bg-white w-full text-left"
          data-message="How did the 1862 'Chinese Police Tax' fuel vigilante attacks? Cite primary and modern sources."
        >
          <div class="flex items-center mb-2">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-amber-100 text-amber-700 mr-2">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
            </span>
            <span class="font-display font-semibold text-sm">Chinese Police Tax</span>
          </div>
          <p class="text-xs text-gray-600">How the 1862 'Chinese Police Tax' fueled vigilante attacks with primary and modern sources.</p>
        </button>

        <button 
          class="conversation-starter block group rounded-xl shadow-vintage border border-amber-200 p-3 hover:shadow-lg transition-all duration-200 bg-white w-full text-left"
          data-message="Compare lynching patterns of Chinese immigrants and African Americans in the 1880s."
        >
          <div class="flex items-center mb-2">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-amber-100 text-amber-700 mr-2">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
            </span>
            <span class="font-display font-semibold text-sm">Lynching Patterns</span>
          </div>
          <p class="text-xs text-gray-600">Compare lynching patterns of Chinese immigrants and African Americans in the 1880s.</p>
        </button>
      </div>
    </div>

    <!-- Chat Interface -->
    <div class="bg-white rounded-lg shadow-lg border border-gray-200">
      <!-- Chat Messages Area -->
      <div id="chat-messages" class="h-96 overflow-y-auto p-6 space-y-4">
        <!-- Welcome message -->
        <div class="flex items-start space-x-3">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
              <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
              </svg>
            </div>
          </div>
          <div class="flex-1 bg-gray-50 rounded-lg p-3">
            <p class="text-sm text-gray-600">
              Hello! Ask me anything about specific events, patterns, locations, or general questions about this historical period.
            </p>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="border-t border-gray-200 p-4">
        <form id="chat-form" class="flex space-x-3">
          <div class="flex-1">
            <input 
              type="text" 
              id="message-input"
              placeholder="Ask about lynchings, riots, specific locations, or historical patterns..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            >
          </div>
          <button 
            type="submit"
            id="send-button"
            class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
          >
            <span>Send</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
          </button>
        </form>
      </div>
    </div>

    <!-- Loading indicator -->
    <div id="loading" class="hidden mt-4 text-center">
      <div class="inline-flex items-center space-x-2 text-gray-600">
        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
        <span>Thinking...</span>
      </div>
    </div>

    <!-- Error message -->
    <div id="error-message" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
      <p class="text-red-600 text-sm"></p>
    </div>
  </div>
</PageLayout>

<script>
  (function() {
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form') as HTMLFormElement;
    const messageInput = document.getElementById('message-input') as HTMLInputElement;
    const sendButton = document.getElementById('send-button') as HTMLButtonElement;
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');

    if (!chatMessages || !chatForm || !messageInput || !sendButton || !loading || !errorMessage) {
      console.error('Required chat elements not found');
      return;
    }

    function addMessage(content: string, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-start space-x-3';
    
    const iconDiv = document.createElement('div');
    iconDiv.className = 'flex-shrink-0';
    
    const icon = document.createElement('div');
    icon.className = isUser 
      ? 'w-8 h-8 bg-green-500 rounded-full flex items-center justify-center'
      : 'w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center';
    
    const svg = document.createElement('svg');
    svg.className = 'w-5 h-5 text-white';
    svg.setAttribute('fill', 'currentColor');
    svg.setAttribute('viewBox', '0 0 20 20');
    
    if (isUser) {
      svg.innerHTML = '<path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>';
    } else {
      svg.innerHTML = '<path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>';
    }
    
    icon.appendChild(svg);
    iconDiv.appendChild(icon);
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'flex-1 bg-gray-50 rounded-lg p-3 chat-message';
    
    const paragraph = document.createElement('div');
    paragraph.className = 'text-sm text-gray-600';
    paragraph.innerHTML = content;
    
    // Style links within this message
    const links = paragraph.querySelectorAll('a');
    links.forEach(link => {
      link.style.color = '#2563eb';
      link.style.textDecoration = 'underline';
      link.style.fontWeight = '500';
      link.style.cursor = 'pointer';
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
    });
    
    contentDiv.appendChild(paragraph);
    messageDiv.appendChild(iconDiv);
    messageDiv.appendChild(contentDiv);
    
    chatMessages!.appendChild(messageDiv);
    chatMessages!.scrollTop = chatMessages!.scrollHeight;
  }

  function showLoading() {
    loading!.classList.remove('hidden');
    sendButton.disabled = true;
  }

  function hideLoading() {
    loading!.classList.add('hidden');
    sendButton.disabled = false;
  }

  function showError(message: string) {
    errorMessage!.classList.remove('hidden');
    const errorText = errorMessage!.querySelector('p');
    if (errorText) {
      errorText.textContent = message;
    }
  }

  function hideError() {
    errorMessage!.classList.add('hidden');
  }

  // Add conversation starter functionality
  const conversationStarters = document.querySelectorAll('.conversation-starter');
  conversationStarters.forEach(button => {
    button.addEventListener('click', () => {
      const message = button.getAttribute('data-message');
      if (message) {
        messageInput.value = message;
        messageInput.focus();
      }
    });
  });

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Add user message
    addMessage(message, true);
    messageInput.value = '';
    
    // Show loading
    showLoading();
    hideError();
    
    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      // Add assistant response
      addMessage(data.response);
      
    } catch (error) {
      console.error('Error:', error);
      showError('Sorry, there was an error processing your request. Please try again.');
    } finally {
      hideLoading();
    }
  });
  })();
</script>
