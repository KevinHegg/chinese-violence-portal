---
import PageLayout from "../../layouts/PageLayout.astro";
import ArticleViewer from "../../components/ArticleViewer.astro";
import { fetchLynchingsData, fetchLynchingsMainData, fetchArticlesData } from "../../utils/googleSheets";
import { getMapboxStaticImageUrl } from "../../utils/mapboxStaticImage";
import { getMapImageUrlWithFallback } from "../../utils/googleDriveImage";

// Disable prerendering to allow dynamic data from Google Sheets
export const prerender = false;

// Fetch data from both Public and Main tabs
const mainTabGid = import.meta.env.PUBLIC_LYNCHINGS_MAIN_GID || "760826284";
const [publicResult, mainResult, articlesData] = await Promise.allSettled([
  fetchLynchingsData(),
  fetchLynchingsMainData(mainTabGid),
  fetchArticlesData()
]);

const publicData = publicResult.status === "fulfilled" ? publicResult.value : [];
const mainData = mainResult.status === "fulfilled" ? mainResult.value : [];
const articlesDataResolved = articlesData.status === "fulfilled" ? articlesData.value : [];

// Helpers: normalize article ID (e.g. "44" -> "0044"); merge Main+Public article-ids (union, dedupe)
const normalizeId = (id: string) => String(id || '').trim().padStart(4, '0');
const mergeArticleIds = (mainIds: string[] | undefined, publicIds: string[] | undefined): string[] => {
  const main = Array.isArray(mainIds) ? mainIds : [];
  const pub = Array.isArray(publicIds) ? publicIds : [];
  const seen = new Set<string>();
  const out: string[] = [];
  for (const id of [...main, ...pub]) {
    const n = normalizeId(id);
    if (!n || seen.has(n)) continue;
    seen.add(n);
    out.push(typeof id === 'string' ? id.trim() : String(id).trim());
  }
  return out;
};

// Main tab may have multiple rows per lynching (e.g. one per article). Aggregate article-ids across all rows.
type MainEntry = { record: any; articleIds: string[] };
const mainDataMap = new Map<string, MainEntry>();
mainData.forEach((record: any) => {
  const lid = record["lynching-id"];
  if (!lid) return;
  const ids = Array.isArray(record["article-ids"]) ? record["article-ids"] : [];
  const existing = mainDataMap.get(lid);
  if (existing) {
    existing.articleIds = mergeArticleIds(existing.articleIds, ids);
  } else {
    mainDataMap.set(lid, { record, articleIds: [...ids] });
  }
});

// Merge: Public base + Main narrative + merged article-ids (Main + Public)
const lynchingsData = publicData.map((record: any) => {
  const entry = mainDataMap.get(record["lynching-id"]);
  if (entry) {
    const m = entry.record;
    return {
      ...record,
      "narrative-title": m["narrative-title"] || record["narrative-title"],
      "narrative-short-title": m["narrative-short-title"] || record["narrative-short-title"],
      "narrative-body": m["narrative-body"] || m["narrative-summary"] || record["narrative-body"],
      "narrative-summary": m["narrative-summary"] || m["narrative-body"] || record["narrative-summary"],
      "compiled-by": m["compiled-by"] || record["compiled-by"],
      "map-image-file-id": record["map-image-file-id"] || m["map-image-file-id"],
      "article-ids": mergeArticleIds(entry.articleIds, record["article-ids"])
    };
  }
  return record;
});

// Get the lynching ID from URL params
const lynchingId = Astro.params.lynchingId;
const lynching = lynchingsData.find((l: any) => l["lynching-id"] === lynchingId);

// Check for querystring parameter to hide metadata panel
const url = Astro.url;
const hideMetadata = url.searchParams.has('hideMetadata') || url.searchParams.has('hide-panel');

// Check if lynching data exists
if (!lynching) {
  return Astro.redirect('/404');
}

// Related articles: lynching "Newspaper IDs" (Main+Public, semicolon-parsed) -> resolve by article-id.
// Also include articles where lynching-id matches (union, dedupe by article-id).
const articleById = new Map<string, any>();
articlesDataResolved.forEach((a: any) => {
  const id = (a["article-id"] || "").trim();
  if (id) {
    articleById.set(normalizeId(id), a);
    articleById.set(id, a);
  }
});
const byId = new Set<string>();
const relatedArticles: any[] = [];
for (const rawId of lynching["article-ids"] || []) {
  const id = typeof rawId === "string" ? rawId.trim() : String(rawId).trim();
  if (!id) continue;
  const n = normalizeId(id);
  if (byId.has(n)) continue;
  const a = articleById.get(n) ?? articleById.get(id);
  if (a) {
    byId.add(n);
    relatedArticles.push(a);
  }
}
for (const a of articlesDataResolved) {
  if ((a["lynching-id"] || "").trim() !== lynchingId) continue;
  const n = normalizeId(a["article-id"]);
  if (byId.has(n)) continue;
  byId.add(n);
  relatedArticles.push(a);
}
relatedArticles.sort((a: any, b: any) => {
  const da = a["publication-date"] || "";
  const db = b["publication-date"] || "";
  if (da !== db) return da.localeCompare(db);
  return (a["article-id"] || "").localeCompare(b["article-id"] || "");
});

// Get navigation data
const allLynchings = lynchingsData; // Use original order from JSON (chronological)
const currentIndex = allLynchings.findIndex((l: any) => l["lynching-id"] === lynching["lynching-id"]);
const prevLynching = currentIndex > 0 ? allLynchings[currentIndex - 1] : null;
const nextLynching = currentIndex < allLynchings.length - 1 ? allLynchings[currentIndex + 1] : null;

// Format date for display
const formatDate = (dateStr: string) => {
  if (!dateStr) return "Unknown";
  // Handle YYYY-MM-DD or YYYY-MM-00 or YYYY-00-00
  const [year, month, day] = dateStr.split("-");
  if (!year) return dateStr;
  if (month === "00" || !month) return year;
  const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];
  const monthIndex = parseInt(month, 10) - 1;
  if (isNaN(monthIndex) || monthIndex < 0 || monthIndex > 11) return year;
  const monthName = monthNames[monthIndex];
  if (day === "00" || !day) {
    return `${monthName} ${year}`;
  }
  return `${monthName} ${parseInt(day, 10)}, ${year}`;
};

// Improved HTML entity decoding for more entities
const decodeHtmlEntities = (text: string) => {
  if (!text) return '';
  return text
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/&ldquo;/g, '"')
    .replace(/&rdquo;/g, '"')
    .replace(/&lsquo;/g, "'")
    .replace(/&rsquo;/g, "'")
    .replace(/&ndash;/g, '–')
    .replace(/&mdash;/g, '—')
    .replace(/&iacute;/g, 'í')
    .replace(/&eacute;/g, 'é')
    .replace(/&aacute;/g, 'á')
    .replace(/&oacute;/g, 'ó')
    .replace(/&uacute;/g, 'ú')
    .replace(/&Uuml;/g, 'Ü')
    .replace(/&uuml;/g, 'ü')
    .replace(/&Aacute;/g, 'Á')
    .replace(/&Eacute;/g, 'É')
    .replace(/&Oacute;/g, 'Ó')
    .replace(/&Uacute;/g, 'Ú')
    .replace(/&ntilde;/g, 'ñ')
    .replace(/&Ntilde;/g, 'Ñ');
};
---

<PageLayout title={decodeHtmlEntities(lynching["narrative-short-title"] || lynching["narrative-title"] || lynching["lynching-id"])} currentPage="records">
      <div class="container-standard mt-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="Breadcrumb" class="mb-4">
      <ol class="flex items-center text-sm flex-wrap">
        <li class="flex items-center">
          <a href="/" class="text-gray-700 hover:text-accent hover:underline transition-colors">Home</a>
          <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </li>
        <li class="flex items-center">
          <a href="/explore" class="text-gray-700 hover:text-accent hover:underline transition-colors">Explore the Records</a>
          <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </li>
        <li class="text-gray-500 font-normal truncate max-w-xs" aria-current="page">
          {decodeHtmlEntities(lynching["narrative-short-title"])}
        </li>
      </ol>
    </nav>

    <!-- Prev/Next Navigation - Always Visible -->
    <div class="flex justify-between items-center mb-4 bg-amber-50 border border-amber-200 rounded-lg p-3">
      <div class="flex-1">
        {prevLynching ? (
          <a href={`/records/${prevLynching["lynching-id"]}`} class="flex items-center gap-2 text-sm text-gray-700 hover:text-accent transition-colors group">
            <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            <span class="hidden sm:inline truncate max-w-[150px]">{decodeHtmlEntities(prevLynching["narrative-short-title"] || "")}</span>
            <span class="sm:hidden">Previous</span>
          </a>
        ) : (
          <span class="text-sm text-gray-400">No previous record</span>
        )}
      </div>
      <div class="text-center px-4">
        <span class="text-xs text-gray-500">Record {currentIndex + 1} of {allLynchings.length}</span>
      </div>
      <div class="flex-1 text-right">
        {nextLynching ? (
          <a href={`/records/${nextLynching["lynching-id"]}`} class="inline-flex items-center gap-2 text-sm text-gray-700 hover:text-accent transition-colors group">
            <span class="hidden sm:inline truncate max-w-[150px]">{decodeHtmlEntities(nextLynching["narrative-short-title"] || "")}</span>
            <span class="sm:hidden">Next</span>
            <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        ) : (
          <span class="text-sm text-gray-400">No next record</span>
        )}
      </div>
    </div>

    <!-- Main Content -->
    <div class="border border-gray-200 shadow-sm overflow-hidden bg-amber-50 rounded-lg">
      <!-- Header (now part of the main content container for seamless background) -->
      <div class="border-b border-amber-200 py-2">
        <h1 class="text-3xl font-bold text-gray-900 mb-1" style="padding-left: 21px;">{decodeHtmlEntities(lynching["narrative-short-title"] || lynching["narrative-title"])} </h1>
      </div>

      <!-- Metadata with Map -->
      <div class="px-10 p-6 border-b border-gray-200 bg-white" style="padding-left: 20px; padding-right: 20px;">
        <div class="flex gap-6 items-start md:flex-row flex-col-reverse md:gap-6 gap-2">
          <!-- Metadata Table -->
          {!hideMetadata && (
          <div class="flex-1 w-full">
            <div class="metadata-list" role="table" aria-label="Lynching record metadata">
              <div class="metadata-item"><span class="metadata-label">Date:</span><span class="metadata-value">{formatDate(lynching["date"])}</span></div>
              <div class="metadata-item"><span class="metadata-label">Location:</span><span class="metadata-value">{(!lynching["city"] && lynching["county"]) ? `${lynching["county"]} County, ${lynching["state"]}` : `${lynching["city"]}, ${lynching["state"]}`}</span></div>
              <div class="metadata-item"><span class="metadata-label">Event Type:</span><span class="metadata-value">{lynching["event-type"]}</span></div>
              <div class="metadata-item"><span class="metadata-label">Victim Names:</span><span class="metadata-value">{lynching["victim-names"].join(", ")}</span></div>
              <div class="metadata-item"><span class="metadata-label">Victim Gender:</span><span class="metadata-value">{lynching["victim-gender"]}</span></div>
              <div class="metadata-item"><span class="metadata-label whitespace-nowrap">No. of Victims:</span><span class="metadata-value">{lynching["number-of-victims"]}</span></div>
              <div class="metadata-item"><span class="metadata-label">Accusation:</span><span class="metadata-value">{lynching["accusation"] || "Unknown"}</span></div>
              <div class="metadata-item"><span class="metadata-label">Killing Method:</span><span class="metadata-value">{lynching["killing-method"] || "Unknown"}</span></div>
              {lynching["job"] && (
                <div class="metadata-item"><span class="metadata-label">Occupation:</span><span class="metadata-value">{lynching["job"]}</span></div>
              )}
              <div class="metadata-item"><span class="metadata-label">Compiled By:</span><span class="metadata-value">{lynching["compiled-by"]}</span></div>
            </div>
          </div>
          )}
          <!-- Map Image -->
          <div class="flex-shrink-0 w-full md:w-auto">
            {(() => {
              // If coordinates exist, link to Google Maps; otherwise no link
              const hasCoordinates = !!(lynching.latitude && lynching.longitude && 
                                       lynching.latitude !== 0 && lynching.longitude !== 0);
              
              // Get map image URL with fallback chain:
              // 1. Google Drive (if file ID exists from Apps Script)
              // 2. Local static file (/mapimages/{id}.png)
              // 3. Mapbox API (on-demand generation)
              const mapImageUrls = getMapImageUrlWithFallback(
                lynching["lynching-id"],
                lynching["map-image-file-id"], // From Google Sheet (Apps Script stores this)
                lynching.longitude,
                lynching.latitude
              );
              
              const imageSrc = mapImageUrls.primary;
              const fallbackUrl = mapImageUrls.fallback;
              
              // Google Maps URL with coordinates - zoomed out to show state borders and nearby states
              // Using the @lat,lon,zoomz format in the URL path for better control
              // Offset the center to the WEST (decrease longitude) so marker appears more to the EAST (right) on screen
              // This makes the marker appear more centered when the map opens, away from the left panel
              // The q parameter shows the marker at actual coordinates, while ll sets the view center
              const centerOffset = 3.75; // Offset longitude to the WEST (degrees) - subtract to move marker to the right on screen
              const centerLongitude = hasCoordinates ? lynching.longitude - centerOffset : lynching.longitude;
              const googleMapsUrl = hasCoordinates 
                ? `https://www.google.com/maps?q=${lynching.latitude},${lynching.longitude}&ll=${lynching.latitude},${centerLongitude}&z=6`
                : null;
              
              if (googleMapsUrl) {
                return (
                  <a
                    href={googleMapsUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="block hover:opacity-80 transition-opacity"
                    title={`View location on Google Maps: ${lynching["city"] || lynching["county"]}, ${lynching["state"]}`}
                  >
                    <img 
                      src={imageSrc}
                      alt={`Map showing location of ${lynching["city"]}, ${lynching["state"]}`}
                      class="map-image-mobile md:w-[300px] md:h-[300px] w-full h-[100px] object-cover object-center rounded-lg border border-gray-200 cursor-pointer"
                      style="width:100%;max-width:300px;"
                      onerror={fallbackUrl ? `this.src='${fallbackUrl}'; this.onerror=null;` : "this.style.display='none'; this.nextElementSibling.style.display='flex';"}
                    />
                  </a>
                );
              } else {
                return (
                  <div class="block">
                    <img 
                      src={imageSrc}
                      alt={`Map showing location of ${lynching["city"]}, ${lynching["state"]}`}
                      class="map-image-mobile md:w-[300px] md:h-[300px] w-full h-[100px] object-cover object-center rounded-lg border border-gray-200"
                      style="width:100%;max-width:300px;"
                      onerror={fallbackUrl ? `this.src='${fallbackUrl}'; this.onerror=null;` : "this.style.display='none'; this.nextElementSibling.style.display='flex';"}
                    />
                  </div>
                );
              }
            })()}
            <div class="hidden md:w-[300px] md:h-[300px] w-full h-[100px] bg-gray-100 rounded-lg border border-gray-200 items-center justify-center text-gray-500">
              <div class="text-center">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
                </svg>
                <p class="text-sm">Map not available</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Narrative -->
      <div class="p-6 border-b border-gray-200" style="background-color: #faf9f6;">
        <h2 class="text-xl font-semibold mb-4">Narrative</h2>
        <div class="prose max-w-none w-full" style="width:100%; max-width:none;" set:html={decodeHtmlEntities(lynching["narrative-body"] || lynching["narrative-summary"] || "")}></div>
      </div>

      <!-- Related Articles -->
      {relatedArticles.length > 0 && (
        <div class="p-6 bg-white">
          <h2 class="text-xl font-semibold mb-4">Related Newspaper Article(s)</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {relatedArticles.map(article => (
              <div class="card related-article-card bg-base-100 shadow-md hover:shadow-lg transition-shadow cursor-pointer border border-base-300" data-article-id={article["article-id"]}>
                <div class="card-body p-4">
                  <div class="flex justify-between items-start mb-3">
                    <h3 class="card-title text-base font-semibold line-clamp-3 flex-1">{article["article-title"] || 'Untitled'}</h3>
                  </div>
                  <p class="text-sm text-gray-600 mb-2">
                    <span class="font-medium">{article.newspaper || 'Unknown Publication'}</span>{article["newspaper-location"] ? ` (${article["newspaper-location"]})` : ''}
                  </p>
                  <p class="text-sm text-gray-500 mb-3">
                    {formatDate(article["publication-date"])}{article.page ? ` (Page ${article.page})` : ''}
                  </p>
                  <div class="summary-container relative">
                    <p class="text-sm text-gray-700 summary-text">{article["article-summary"] || 'No summary available.'}</p>
                    <div class="summary-fade"></div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>

  <!-- Article Viewer Component -->
  <ArticleViewer />
</PageLayout>

<script define:vars={{ relatedArticles }}>
  // Client-side formatDate function
  function formatDate(dateStr) {
    if (!dateStr) return "Unknown";
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return dateStr;
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  // Add click handlers to related article cards (use data-article-id for reliable lookup)
  document.addEventListener('DOMContentLoaded', function() {
    const articleCards = document.querySelectorAll('.related-article-card');
    articleCards.forEach(card => {
      card.addEventListener('click', function() {
        const id = this.getAttribute('data-article-id');
        const article = relatedArticles.find(a => (a['article-id'] || '').trim() === (id || '').trim());
        if (article) {
          openArticleViewer(article);
        }
      });
    });
  });

  function openArticleViewer(article) {
    // Create title with newspaper metadata
    const newspaperName = article.newspaper || 'Unknown Publication';
    const publicationDate = formatDate(article['publication-date']);
    const titleWithMetadata = `${article['article-title'] || 'Untitled Article'} - ${newspaperName}, ${publicationDate}`;
    
    // Set image path
    const imagePath = `/article-scans/${article.image_name}`;
    
    // Transcription with proper formatting
    const transcript = (article['article-transcript'] || 'No transcription available.')
      .replace(/⏎/g, '\n')
      .split(/\n/)
      .map(paragraph => paragraph.trim())
      .filter(paragraph => paragraph.length > 0);
      const formattedTranscript = transcript.map((p, index) => {
        return `<p class='leading-relaxed'>${p}</p>`;
      }).join('');
    
    // Use the new component's API
    if (window.articleViewer) {
      window.articleViewer.show({
        title: titleWithMetadata,
        imageUrl: imagePath,
        transcription: formattedTranscript,
        citation: article['turabian-citation'] || 'Citation not available.'
      });
    }
  }
  

</script>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .summary-container {
    max-height: 120px;
    overflow: hidden;
  }

  .summary-text {
    margin-bottom: 0;
  }

  .summary-fade {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(transparent, white);
    pointer-events: none;
  }

  /* Metadata list styling - labels and values in two-column layout, both left-aligned */
  .metadata-list {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin: 0;
    padding: 0;
  }
  
  .metadata-item {
    display: flex !important;
    flex-direction: row !important;
    align-items: flex-start;
    padding-top: 0.25rem;
    padding-bottom: 0.25rem;
    margin: 0 !important;
    width: 100%;
  }
  
  .metadata-label {
    text-align: left !important;
    font-weight: 600;
    white-space: nowrap;
    flex-shrink: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
    margin-right: 0.5rem !important;
    width: 140px;
    min-width: 140px;
    max-width: 140px;
  }
  
  .metadata-value {
    text-align: left !important;
    margin: 0 !important;
    padding: 0 !important;
    flex: 1 1 auto !important;
    min-width: 0;
  }

  @media (max-width: 800px) {
    .map-image-mobile {
      width: 100% !important;
      height: 110px !important;
      object-fit: cover !important;
      object-position: center !important;
      border-radius: 0.5rem !important;
      margin-bottom: 0.5rem !important;
      display: block !important;
      max-width: 100vw !important;
    }
    .md\\:w-\[300px\] {
      width: 100% !important;
    }
    .md\\:h-\[300px\] {
      height: 110px !important;
    }
    .flex-col-reverse {
      flex-direction: column-reverse !important;
    }
    .flex-row {
      flex-direction: row !important;
    }
  }
</style> 