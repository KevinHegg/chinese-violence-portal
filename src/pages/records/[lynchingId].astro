---
import PageLayout from "../../layouts/PageLayout.astro";
import ArticleViewer from "../../components/ArticleViewer.astro";
import { fetchLynchingsData, fetchLynchingsMainData, fetchArticlesData } from "../../utils/googleSheets";

// Disable prerendering to allow dynamic data from Google Sheets
export const prerender = false;

// Fetch data from both Public and Main tabs
const mainTabGid = import.meta.env.PUBLIC_LYNCHINGS_MAIN_GID || "760826284";
const [publicResult, mainResult, articlesData] = await Promise.allSettled([
  fetchLynchingsData(),
  fetchLynchingsMainData(mainTabGid),
  fetchArticlesData()
]);

const publicData = publicResult.status === "fulfilled" ? publicResult.value : [];
const mainData = mainResult.status === "fulfilled" ? mainResult.value : [];
const articlesDataResolved = articlesData.status === "fulfilled" ? articlesData.value : [];

// Merge Main tab data (narrative-title, narrative-body/narrative-summary) with Public tab data
const mainDataMap = new Map();
mainData.forEach((record: any) => {
  if (record["lynching-id"]) {
    mainDataMap.set(record["lynching-id"], record);
  }
});

// Merge: use Public data as base, enrich with Main data where available
const lynchingsData = publicData.map((record: any) => {
  const mainRecord = mainDataMap.get(record["lynching-id"]);
  if (mainRecord) {
    return {
      ...record,
      "narrative-title": mainRecord["narrative-title"] || record["narrative-title"],
      "narrative-short-title": mainRecord["narrative-short-title"] || record["narrative-short-title"],
      "narrative-body": mainRecord["narrative-body"] || mainRecord["narrative-summary"] || record["narrative-body"],
      "narrative-summary": mainRecord["narrative-summary"] || mainRecord["narrative-body"] || record["narrative-summary"]
    };
  }
  return record;
});

// Get the lynching ID from URL params
const lynchingId = Astro.params.lynchingId;
const lynching = lynchingsData.find((l: any) => l["lynching-id"] === lynchingId);

// Check if lynching data exists
if (!lynching) {
  return Astro.redirect('/404');
}

// Get related articles
const relatedArticles = [];
if (lynching["article-ids"] && Array.isArray(lynching["article-ids"])) {
  for (const articleId of lynching["article-ids"]) {
    const article = articlesDataResolved.find((a: any) => a["article-id"] === articleId);
    if (article) {
      relatedArticles.push(article);
    }
  }
}

// Get navigation data
const allLynchings = lynchingsData; // Use original order from JSON (chronological)
const currentIndex = allLynchings.findIndex((l: any) => l["lynching-id"] === lynching["lynching-id"]);
const prevLynching = currentIndex > 0 ? allLynchings[currentIndex - 1] : null;
const nextLynching = currentIndex < allLynchings.length - 1 ? allLynchings[currentIndex + 1] : null;

// Format date for display
const formatDate = (dateStr: string) => {
  if (!dateStr) return "Unknown";
  // Handle YYYY-MM-DD or YYYY-MM-00 or YYYY-00-00
  const [year, month, day] = dateStr.split("-");
  if (!year) return dateStr;
  if (month === "00" || !month) return year;
  const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];
  const monthIndex = parseInt(month, 10) - 1;
  if (isNaN(monthIndex) || monthIndex < 0 || monthIndex > 11) return year;
  const monthName = monthNames[monthIndex];
  if (day === "00" || !day) {
    return `${monthName} ${year}`;
  }
  return `${monthName} ${parseInt(day, 10)}, ${year}`;
};

// Improved HTML entity decoding for more entities
const decodeHtmlEntities = (text: string) => {
  if (!text) return '';
  return text
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/&ldquo;/g, '"')
    .replace(/&rdquo;/g, '"')
    .replace(/&lsquo;/g, "'")
    .replace(/&rsquo;/g, "'")
    .replace(/&ndash;/g, '–')
    .replace(/&mdash;/g, '—')
    .replace(/&iacute;/g, 'í')
    .replace(/&eacute;/g, 'é')
    .replace(/&aacute;/g, 'á')
    .replace(/&oacute;/g, 'ó')
    .replace(/&uacute;/g, 'ú')
    .replace(/&Uuml;/g, 'Ü')
    .replace(/&uuml;/g, 'ü')
    .replace(/&Aacute;/g, 'Á')
    .replace(/&Eacute;/g, 'É')
    .replace(/&Oacute;/g, 'Ó')
    .replace(/&Uacute;/g, 'Ú')
    .replace(/&ntilde;/g, 'ñ')
    .replace(/&Ntilde;/g, 'Ñ');
};
---

<PageLayout title={decodeHtmlEntities(lynching["narrative-title"] || lynching["narrative-short-title"] || lynching["lynching-id"])} currentPage="records">
      <div class="container-standard mt-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="Breadcrumb" class="mb-4">
      <ol class="flex items-center text-sm text-gray-600 flex-wrap">
        <li class="flex items-center">
          <a href="/" class="hover:text-accent transition-colors">Home</a>
          <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </li>
        <li class="flex items-center">
          <a href="/explore" class="hover:text-accent transition-colors">Explore the Records</a>
          <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </li>
        <li class="text-gray-900 font-medium truncate max-w-xs" aria-current="page">
          {decodeHtmlEntities(lynching["narrative-short-title"])}
        </li>
      </ol>
    </nav>

    <!-- Prev/Next Navigation - Always Visible -->
    <div class="flex justify-between items-center mb-4 bg-amber-50 border border-amber-200 rounded-lg p-3">
      <div class="flex-1">
        {prevLynching ? (
          <a href={`/records/${prevLynching["lynching-id"]}`} class="flex items-center gap-2 text-sm text-gray-700 hover:text-accent transition-colors group">
            <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            <span class="hidden sm:inline truncate max-w-[150px]">{prevLynching["narrative-short-title"]}</span>
            <span class="sm:hidden">Previous</span>
          </a>
        ) : (
          <span class="text-sm text-gray-400">No previous record</span>
        )}
      </div>
      <div class="text-center px-4">
        <span class="text-xs text-gray-500">Record {currentIndex + 1} of {allLynchings.length}</span>
      </div>
      <div class="flex-1 text-right">
        {nextLynching ? (
          <a href={`/records/${nextLynching["lynching-id"]}`} class="inline-flex items-center gap-2 text-sm text-gray-700 hover:text-accent transition-colors group">
            <span class="hidden sm:inline truncate max-w-[150px]">{nextLynching["narrative-short-title"]}</span>
            <span class="sm:hidden">Next</span>
            <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        ) : (
          <span class="text-sm text-gray-400">No next record</span>
        )}
      </div>
    </div>

    <!-- Main Content -->
    <div class="border border-gray-200 shadow-sm overflow-hidden bg-amber-50 rounded-lg">
      <!-- Header (now part of the main content container for seamless background) -->
      <div class="border-b border-amber-200 py-2">
        <h1 class="text-3xl font-bold text-gray-900 mb-1" style="padding-left: 21px;">{decodeHtmlEntities(lynching["narrative-title"] || lynching["narrative-short-title"])} </h1>
      </div>

      <!-- Metadata with Map -->
      <div class="px-10 p-6 border-b border-gray-200 bg-white" style="padding-left: 20px; padding-right: 20px;">
        <div class="flex gap-6 items-start md:flex-row flex-col-reverse md:gap-6 gap-2">
          <!-- Metadata Table -->
          <div class="flex-1 w-full">
            <table class="w-full text-left align-top" style="border-spacing:0;border-collapse:collapse;">
              <tbody>
                <tr class="table-row"><th class="table-header">Date:</th><td class="table-cell">{formatDate(lynching["date"])}</td></tr>
                <tr class="table-row"><th class="table-header">Location:</th><td class="table-cell">{(!lynching["city"] && lynching["county"]) ? `${lynching["county"]} County, ${lynching["state"]}` : `${lynching["city"]}, ${lynching["state"]}`}</td></tr>
                <tr class="table-row"><th class="table-header">Event Type:</th><td class="table-cell">{lynching["event-type"]}</td></tr>
                <tr class="table-row"><th class="table-header">Victim Names:</th><td class="table-cell">{lynching["victim-names"].join(", ")}</td></tr>
                <tr class="table-row"><th class="table-header">Victim Gender:</th><td class="table-cell">{lynching["victim-gender"]}</td></tr>
                <tr class="table-row"><th class="table-header whitespace-nowrap">No. of Victims:</th><td class="table-cell">{lynching["number-of-victims"]}</td></tr>
                <tr class="table-row"><th class="table-header">Accusation:</th><td class="table-cell">{lynching["accusation"] || "Unknown"}</td></tr>
                <tr><th class="table-header">Source:</th><td class="table-cell">{lynching["source"]}</td></tr>
                {lynching["job"] && (
                  <tr><th class="table-header">Occupation:</th><td class="table-cell">{lynching["job"]}</td></tr>
                )}
              </tbody>
            </table>
          </div>
          <!-- Map Image -->
          <div class="flex-shrink-0 w-full md:w-auto">
            <a
              id="map-link"
              data-lynching-id={lynching["lynching-id"]}
              href="#"
              class="block hover:opacity-80 transition-opacity"
              title="View interactive map"
            >
              <img 
                src={`/mapimages/${lynching["lynching-id"]}.png`} 
                alt={`Map showing location of ${lynching["city"]}, ${lynching["state"]}`}
                class="map-image-mobile md:w-[300px] md:h-[300px] w-full h-[100px] object-cover object-center rounded-lg border border-gray-200 cursor-pointer"
                style="width:100%;max-width:300px;"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
              />
            </a>
            <script is:inline>
              document.addEventListener('DOMContentLoaded', function() {
                var mapLink = document.getElementById('map-link');
                if (mapLink) {
                  var fromlink = encodeURIComponent(window.location.pathname + window.location.search);
                  var lynchingId = mapLink.getAttribute('data-lynching-id');
                  var linklabel = encodeURIComponent('Back to Record ' + lynchingId);
                  mapLink.href = '/visualize/map?fromlink=' + fromlink + '&linklabel=' + linklabel;
                }
              });
            </script>
            <div class="hidden md:w-[300px] md:h-[300px] w-full h-[100px] bg-gray-100 rounded-lg border border-gray-200 items-center justify-center text-gray-500">
              <div class="text-center">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
                </svg>
                <p class="text-sm">Map not available</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Narrative -->
      <div class="p-6 border-b border-gray-200" style="background-color: #faf9f6;">
        <h2 class="text-xl font-semibold mb-4">Narrative</h2>
        <div class="prose max-w-none w-full" style="width:100%; max-width:none;" set:html={decodeHtmlEntities(lynching["narrative-body"] || lynching["narrative-summary"] || "")}></div>
      </div>

      <!-- Related Articles -->
      {relatedArticles.length > 0 && (
        <div class="p-6 bg-white">
          <h2 class="text-xl font-semibold mb-4">Related Newspaper Articles</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {relatedArticles.map(article => (
              <div class="card bg-base-100 shadow-md hover:shadow-lg transition-shadow cursor-pointer border border-base-300">
                <div class="card-body p-4">
                  <div class="flex justify-between items-start mb-3">
                    <h3 class="card-title text-base font-semibold line-clamp-3 flex-1">{article["article-title"] || 'Untitled'}</h3>
                  </div>
                  <p class="text-sm text-gray-600 mb-2">
                    <span class="font-medium">{article.newspaper || 'Unknown Publication'}</span>{article["newspaper-location"] ? ` (${article["newspaper-location"]})` : ''}
                  </p>
                  <p class="text-sm text-gray-500 mb-3">
                    {formatDate(article["publication-date"])}{article.page ? ` (Page ${article.page})` : ''}
                  </p>
                  <div class="summary-container relative">
                    <p class="text-sm text-gray-700 summary-text">{article["article-summary"] || 'No summary available.'}</p>
                    <div class="summary-fade"></div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>

  <!-- Article Viewer Component -->
  <ArticleViewer />
</PageLayout>

<script define:vars={{ relatedArticles }}>
  // Client-side formatDate function
  function formatDate(dateStr) {
    if (!dateStr) return "Unknown";
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return dateStr;
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  // Add click handlers to article cards
  document.addEventListener('DOMContentLoaded', function() {
    const articleCards = document.querySelectorAll('.card');
    articleCards.forEach(card => {
      card.addEventListener('click', function() {
        // Find the article data from the related articles
        const articleTitle = this.querySelector('.card-title').textContent;
        const article = relatedArticles.find(a => a['article-title'] === articleTitle);
        
        if (article) {
          openArticleViewer(article);
        }
      });
    });
  });

  function openArticleViewer(article) {
    // Create title with newspaper metadata
    const newspaperName = article.newspaper || 'Unknown Publication';
    const publicationDate = formatDate(article['publication-date']);
    const titleWithMetadata = `${article['article-title'] || 'Untitled Article'} - ${newspaperName}, ${publicationDate}`;
    
    // Set image path
    const imagePath = `/article-scans/${article.image_name}`;
    
    // Transcription with proper formatting
    const transcript = (article['article-transcript'] || 'No transcription available.')
      .replace(/⏎/g, '\n')
      .split(/\n/)
      .map(paragraph => paragraph.trim())
      .filter(paragraph => paragraph.length > 0);
    const formattedTranscript = transcript.map((p, index) => {
      return `<p class='leading-snug' style='margin-bottom: 8px; text-indent: 8px;'>${p}</p>`;
    }).join('');
    
    // Use the new component's API
    if (window.articleViewer) {
      window.articleViewer.show({
        title: titleWithMetadata,
        imageUrl: imagePath,
        transcription: formattedTranscript,
        citation: article['turabian-citation'] || 'Citation not available.'
      });
    }
  }
  

</script>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .summary-container {
    max-height: 120px;
    overflow: hidden;
  }

  .summary-text {
    margin-bottom: 0;
  }

  .summary-fade {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(transparent, white);
    pointer-events: none;
  }

  @media (max-width: 800px) {
    .map-image-mobile {
      width: 100% !important;
      height: 110px !important;
      object-fit: cover !important;
      object-position: center !important;
      border-radius: 0.5rem !important;
      margin-bottom: 0.5rem !important;
      display: block !important;
      max-width: 100vw !important;
    }
    .md\\:w-\[300px\] {
      width: 100% !important;
    }
    .md\\:h-\[300px\] {
      height: 110px !important;
    }
    .flex-col-reverse {
      flex-direction: column-reverse !important;
    }
    .flex-row {
      flex-direction: row !important;
    }
  }
</style> 