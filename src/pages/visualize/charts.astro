---
import PageLayout from "../../layouts/PageLayout.astro";
import "../../styles/western-colors.css";
---

<PageLayout title="Anti-Chinese Violence & Chinese Population in the U.S. (1850–1915)" currentPage="visualize/charts">
  <div class="container-wide">
    <h1 class="text-4xl font-bold mb-6 text-amber-800">Anti-Chinese Violence & Chinese Population in the U.S. (1850–1915)</h1>
    <p class="mb-2 text-lg max-w-3xl leading-snug">
      This dashboard visualizes the history and impact of anti-Chinese violence in the U.S. through interactive charts:
    </p>
    <ol class="mb-8 text-base max-w-3xl leading-normal list-decimal list-inside space-y-1 pl-4" style="text-indent:-1.1em;">
      <li><strong>Incidents Over Time:</strong> Annual count of violent events from 1850–1920.</li>
      <li><strong>Victims Over Time:</strong> Annual victim count from 1850–1920.</li>
      <li><strong>Types of Violence:</strong> Breakdown of violence types by victim count.</li>
      <li><strong>Categories & Pretexts:</strong> Distribution of violence categories and stated pretexts.</li>
      <li><strong>Violence & Population:</strong> Victims per year alongside Chinese population growth and key policy events.</li>
    </ol>
    <style>
      ol.list-decimal > li {
        text-indent: -1.1em;
        padding-left: 1.1em;
      }
      
      
    </style>

    <!-- Chart 1: Incidents Over Time -->
         <div class="bg-gradient-to-br from-amber-200 to-yellow-200 border-2 border-amber-500 rounded-xl shadow-2xl p-6 mb-14 mt-8">
      <h2 class="text-xl font-semibold mb-2 text-amber-800">Incidents of Anti-Chinese Violence Over Time</h2>
             <p class="mb-4 text-sm text-amber-700">Annual count of anti-Chinese violence events, 1850–1920.</p>
      <div id="chart-timeline" 
           class="chart-container"
           role="img"
           aria-label="Line chart showing incidents of anti-Chinese violence from 1850 to 1920"
           aria-describedby="chart-timeline-desc"></div>
      <p id="chart-timeline-desc" class="sr-only">This chart displays annual counts of anti-Chinese violence incidents. Peak years include 1885 with 15 incidents and 1886 with 12 incidents. Use the data table below for detailed values.</p>
      <div id="chart-timeline-table" class="sr-only" role="region" aria-label="Data table for incidents over time chart"></div>
    </div>

    <!-- Chart 1b: Victims Over Time -->
         <div class="bg-gradient-to-br from-amber-200 to-yellow-200 border-2 border-amber-500 rounded-xl shadow-2xl p-6 mb-14">
      <h2 class="text-xl font-semibold mb-2 text-amber-800">Number of Victims of Anti-Chinese Violence Over Time</h2>
             <p class="mb-4 text-sm text-amber-700">Annual count of victims, 1850–1920.</p>
      <div id="chart-victims" 
           class="chart-container"
           role="img"
           aria-label="Line chart showing number of victims of anti-Chinese violence from 1850 to 1920"
           aria-describedby="chart-victims-desc"></div>
      <p id="chart-victims-desc" class="sr-only">This chart displays annual counts of victims of anti-Chinese violence. Use the data table below for detailed values.</p>
      <div id="chart-victims-table" class="sr-only" role="region" aria-label="Data table for victims over time chart"></div>
    </div>

    <!-- Chart 2: Types of Violence -->
         <div class="bg-gradient-to-br from-amber-200 to-yellow-200 border-2 border-amber-500 rounded-xl shadow-2xl p-6 mb-14">
      <h2 class="text-xl font-semibold mb-2 text-amber-800">Types of Anti-Chinese Violence</h2>
             <p class="mb-4 text-sm text-amber-700">Breakdown of event types in the lynching records.</p>
      <div id="chart-types" 
           class="chart-container"
           role="img"
           aria-label="Bar chart showing types of anti-Chinese violence by victim count"
           aria-describedby="chart-types-desc"></div>
      <p id="chart-types-desc" class="sr-only">This chart displays a breakdown of event types in the lynching records, showing the number of victims for each type. Use the data table below for detailed values.</p>
      <div id="chart-types-table" class="sr-only" role="region" aria-label="Data table for types of violence chart"></div>
    </div>

    <!-- Chart 3: Dual Pie Charts -->
         <div class="bg-gradient-to-br from-amber-200 to-yellow-200 border-2 border-amber-500 rounded-xl shadow-2xl p-4 mb-14">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div>
          <h2 class="text-lg font-semibold mb-1 text-amber-800 text-center">Categories of Violence</h2>
          <div id="chart-pie-category" 
               style="width: 100%; height: 280px;"
               role="img"
               aria-label="Pie chart showing distribution of categories of violence"
               aria-describedby="chart-pie-category-desc"></div>
          <p id="chart-pie-category-desc" class="sr-only">This pie chart displays the distribution of categories of violence. Use the data table below for detailed values.</p>
          <div id="chart-pie-category-table" class="sr-only" role="region" aria-label="Data table for categories of violence chart"></div>
        </div>
        <div>
          <h2 class="text-lg font-semibold mb-1 text-amber-800 text-center">Pretexts for Violence</h2>
          <div id="chart-pie-pretext" 
               style="width: 100%; height: 280px;"
               role="img"
               aria-label="Pie chart showing distribution of pretexts for violence"
               aria-describedby="chart-pie-pretext-desc"></div>
          <p id="chart-pie-pretext-desc" class="sr-only">This pie chart displays the distribution of pretexts for violence. Use the data table below for detailed values.</p>
          <div id="chart-pie-pretext-table" class="sr-only" role="region" aria-label="Data table for pretexts for violence chart"></div>
        </div>
      </div>
    </div>

    <!-- Chart 4: Combo Chart -->
         <div class="bg-gradient-to-br from-amber-200 to-yellow-200 border-2 border-amber-500 rounded-xl shadow-2xl p-6 mb-12">
      <h2 class="text-xl font-semibold mb-2 text-amber-800">Anti-Chinese Violence & Chinese Population in the U.S. (1850–1915)</h2>
             <p class="mb-4 text-sm text-amber-700">A combination chart showing the number of victims per year (bar), the Chinese population (line), and key policy events (vertical markers).</p>
      <div id="chart-combo" 
           class="chart-container-large"
           role="img"
           aria-label="Combination chart showing victims per year, Chinese population, and key policy events from 1850 to 1915"
           aria-describedby="chart-combo-desc"></div>
      <p id="chart-combo-desc" class="sr-only">This combination chart displays the number of victims per year as bars, the Chinese population as a line, and key policy events as vertical markers. Use the data table below for detailed values.</p>
      <div id="chart-combo-table" class="sr-only" role="region" aria-label="Data table for combination chart"></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script type="module">
    // Load data
    const timelineData = await fetch('/timeline.json').then(r => r.json());
    const lynchingsData = await fetch('/api/lynchings').then(r => r.json());
    // Fetch Main tab data for pie charts (GID 760826284)
    const mainTabData = await fetch('/api/lynchings?gid=760826284').then(r => r.json()).catch(() => lynchingsData);

    // --- Chart 1: Incidents Over Time ---
    // Count incidents by year from lynchings data
    const yearCounts = {};
    lynchingsData.forEach(record => {
      // Try to get year from year field, or extract from date field
      let y = record.year;
      if (!y || y === 0) {
        // Try to extract from date field (format: YYYY-MM-DD or YYYY-MM-00)
        if (record.date) {
          const dateMatch = record.date.match(/^(\d{4})/);
          if (dateMatch) {
            y = parseInt(dateMatch[1]);
          }
        }
      } else {
        y = parseInt(y);
      }
      // Only count valid years in range
      if (y && !isNaN(y) && y >= 1850 && y <= 1920) {
        yearCounts[y] = (yearCounts[y] || 0) + 1;
      }
    });
    // Fill in all years from 1850-1920 for continuity
    const allYears = [];
    for (let y = 1850; y <= 1920; y++) {
      allYears.push(y);
    }
    const years = allYears.map(String);
    const counts = years.map(y => yearCounts[parseInt(y)] || 0);
    
    // Create accessible data table for Chart 1
    function createDataTable(containerId, headers, rows, caption) {
      const container = document.getElementById(containerId);
      if (!container) return;
      const table = document.createElement('table');
      table.setAttribute('aria-label', caption);
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      headers.forEach(header => {
        const th = document.createElement('th');
        th.setAttribute('scope', 'col');
        th.textContent = header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      rows.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }
    
    // Create table for incidents chart
    const timelineTableRows = years.map((y, i) => [y, counts[i].toString()]);
    createDataTable('chart-timeline-table', ['Year', 'Incidents'], timelineTableRows, 'Data table for incidents over time chart');
    
    const chartTimeline = echarts.init(document.getElementById('chart-timeline'));
    chartTimeline.setOption({
      title: { text: '', left: 'center' },
      tooltip: { 
        trigger: 'axis',
        backgroundColor: 'var(--western-wheat)',
        borderColor: 'var(--western-saddle-brown)',
        textStyle: { color: 'var(--western-saddle-brown)' }
      },
      xAxis: { 
        type: 'category', 
        data: years, 
        axisLabel: { align: 'center', color: 'var(--western-saddle-brown)' },
        axisTick: { alignWithLabel: true },
        axisLine: { lineStyle: { color: 'var(--western-sienna)' } }
      },
      yAxis: { 
        type: 'value', 
        name: 'Number of Incidents', 
        nameLocation: 'center', 
        nameGap: 50, 
        nameRotate: 90, 
        nameTextStyle: { fontWeight: 'bold', fontSize: 16, fontFamily: 'sans-serif', color: 'var(--western-saddle-brown)' },
        position: 'left',
        axisLabel: { color: 'var(--western-saddle-brown)' },
        axisLine: { lineStyle: { color: 'var(--western-sienna)' } },
        splitLine: { lineStyle: { color: 'var(--western-burlywood)', opacity: 0.3 } }
      },
      series: [{
        data: counts,
        type: 'line',
        smooth: true,
        lineStyle: { color: 'var(--western-saddle-brown)', width: 3 },
        areaStyle: { color: '#DEB887', opacity: 0.6 }, // burlywood
        symbol: 'circle',
        symbolSize: 8,
        emphasis: {
          focus: 'series',
          lineStyle: { color: 'var(--western-saddle-brown)', width: 4 },
          areaStyle: { color: '#DEB887', opacity: 0.8 }, // burlywood
          itemStyle: {
            color: 'var(--western-saddle-brown)',
            borderColor: 'var(--western-sienna)',
            borderWidth: 2
          }
        }
      }],
      grid: { left: 80, right: 30, top: 50, bottom: 60 },
      responsive: true
    });

    // --- Chart 1b: Victims Over Time ---
    const victimsByYearTimeline = {};
    lynchingsData.forEach(record => {
      let y = record.year;
      if (!y || y === 0) {
        if (record.date) {
          const dateMatch = record.date.match(/^(\d{4})/);
          if (dateMatch) {
            y = parseInt(dateMatch[1]);
          }
        }
      } else {
        y = parseInt(y);
      }
      const victims = Number(record['number-of-victims']) || 0;
      if (y && !isNaN(y) && y >= 1850 && y <= 1920) {
        victimsByYearTimeline[y] = (victimsByYearTimeline[y] || 0) + victims;
      }
    });
    const victimCounts = years.map(y => victimsByYearTimeline[parseInt(y)] || 0);
    
    // Create table for victims chart
    const victimsTableRows = years.map((y, i) => [y, victimCounts[i].toString()]);
    createDataTable('chart-victims-table', ['Year', 'Victims'], victimsTableRows, 'Data table for victims over time chart');
    
    const chartVictims = echarts.init(document.getElementById('chart-victims'));
    chartVictims.setOption({
      title: { text: '', left: 'center' },
      tooltip: { 
        trigger: 'axis',
        backgroundColor: 'var(--western-wheat)',
        borderColor: 'var(--western-saddle-brown)',
        textStyle: { color: 'var(--western-saddle-brown)' }
      },
      xAxis: { 
        type: 'category', 
        data: years, 
        axisLabel: { align: 'center', color: 'var(--western-saddle-brown)' },
        axisTick: { alignWithLabel: true },
        axisLine: { lineStyle: { color: 'var(--western-sienna)' } }
      },
      yAxis: { 
        type: 'value', 
        name: 'Number of Victims', 
        nameLocation: 'center', 
        nameGap: 50, 
        nameRotate: 90, 
        nameTextStyle: { fontWeight: 'bold', fontSize: 16, fontFamily: 'sans-serif', color: 'var(--western-saddle-brown)' },
        position: 'left',
        axisLabel: { color: 'var(--western-saddle-brown)' },
        axisLine: { lineStyle: { color: 'var(--western-sienna)' } },
        splitLine: { lineStyle: { color: 'var(--western-burlywood)', opacity: 0.3 } }
      },
      series: [{
        data: victimCounts,
        type: 'line',
        smooth: true,
        lineStyle: { color: 'var(--western-saddle-brown)', width: 3 },
        areaStyle: { color: '#DEB887', opacity: 0.6 }, // burlywood
        symbol: 'circle',
        symbolSize: 8,
        emphasis: {
          focus: 'series',
          lineStyle: { color: 'var(--western-saddle-brown)', width: 4 },
          areaStyle: { color: '#DEB887', opacity: 0.8 }, // burlywood
          itemStyle: {
            color: 'var(--western-saddle-brown)',
            borderColor: 'var(--western-sienna)',
            borderWidth: 2
          }
        }
      }],
      grid: { left: 80, right: 30, top: 50, bottom: 60 },
      responsive: true
    });

    // --- Chart 2: Types of Violence ---
    const typeCounts = {};
    lynchingsData.forEach(e => {
      const t = e['event-type'] || 'Unknown';
      const victims = Number(e['number-of-victims']) || 1;
      typeCounts[t] = (typeCounts[t] || 0) + victims;
    });
    const typeNames = Object.keys(typeCounts).map(t => t === 'Possible Lynching' ? 'Possible\nLynching' : t);
    const typeVals = typeNames.map((t, i) => typeCounts[Object.keys(typeCounts)[i]]);
    
    // Create table for types chart
    const typesTableRows = typeNames.map((name, i) => [name.replace(/\n/g, ' '), typeVals[i].toString()]);
    createDataTable('chart-types-table', ['Event Type', 'Victims'], typesTableRows, 'Data table for types of violence chart');
    
    const chartTypes = echarts.init(document.getElementById('chart-types'));
    chartTypes.setOption({
      tooltip: { 
        trigger: 'item',
        backgroundColor: 'var(--western-wheat)',
        borderColor: 'var(--western-saddle-brown)',
        textStyle: { color: 'var(--western-saddle-brown)' }
      },
      xAxis: { 
        type: 'category', 
        data: typeNames, 
        name: 'Category', 
        axisLabel: { rotate: 0, formatter: v => v.replace(/\n/g, '\n'), align: 'center', color: 'var(--western-saddle-brown)' }, 
        axisTick: { alignWithLabel: true },
        axisLine: { lineStyle: { color: 'var(--western-sienna)' } }
      },
      yAxis: { 
        type: 'value', 
        name: 'Number of Victims', 
        nameLocation: 'center', 
        nameGap: 50, 
        nameRotate: 90, 
        nameTextStyle: { fontWeight: 'bold', fontSize: 16, fontFamily: 'sans-serif', color: 'var(--western-saddle-brown)' },
        position: 'left',
        axisLabel: { color: 'var(--western-saddle-brown)' },
        axisLine: { lineStyle: { color: 'var(--western-sienna)' } },
        splitLine: { lineStyle: { color: 'var(--western-burlywood)', opacity: 0.3 } }
      },
      series: [{
        data: typeVals,
        type: 'bar',
        label: {
          show: true,
          position: 'top',
          color: '#000000',
          fontWeight: 'bold',
          fontSize: 14
        },
        itemStyle: { 
          color: function(params) {
            const fillColors = [
              '#F4A460', // sandy-brown
              '#DEB887', // burlywood
              '#8B7355', // tan
              '#D2B48C', // light-tan
              '#F5DEB3', // wheat
              '#DAA520', // goldenrod
              '#BC8F8F', // rosy-brown
              '#CD853F', // peru
              '#D2691E', // chocolate
              '#A0522D', // sienna
              '#B8860B', // dark-goldenrod
              '#C19A6B', // medium-wood
              '#8B4513'  // saddle-brown
            ];
            return fillColors[params.dataIndex % fillColors.length];
          },
          borderColor: '#8B7355', // tan - warm neutral brown
          borderWidth: 2,
          borderRadius: [6, 6, 0, 0] 
        },
        barWidth: '60%',
        emphasis: {
          focus: 'series',
          itemStyle: {
            color: function(params) {
              const fillColors = [
                '#F4A460', // sandy-brown
                '#DEB887', // burlywood
                '#8B7355', // tan
                '#D2B48C', // light-tan
                '#F5DEB3', // wheat
                '#DAA520', // goldenrod
                '#BC8F8F', // rosy-brown
                '#CD853F', // peru
                '#D2691E', // chocolate
                '#A0522D', // sienna
                '#B8860B', // dark-goldenrod
                '#C19A6B', // medium-wood
                '#8B4513'  // saddle-brown
              ];
              return fillColors[params.dataIndex % fillColors.length];
            },
                                     borderColor: '#8B7355', // tan - warm neutral brown
            borderWidth: 3,
            shadowBlur: 10,
            shadowColor: 'rgba(0, 0, 0, 0.3)'
          }
        }
      }],
      grid: { left: 80, right: 30, top: 50, bottom: 80 },
      responsive: true
    });
    
    // Update markLine colors after chart is rendered
    setTimeout(() => {
      const markLines = document.querySelectorAll('#chart-types .echarts-mark-line');
      markLines.forEach(line => {
        line.style.color = 'var(--western-sienna)';
      });
    }, 100);

    // --- Chart 3: Dual Pie Charts (from Main tab) ---
    const categoryCounts = {};
    const pretextCounts = {};
    mainTabData.forEach(record => {
      // Category of Violence
      const category = record['category-of-violence'] || record['Category of Violence'] || 'Unknown';
      if (category && category !== 'Unknown') {
        categoryCounts[category] = (categoryCounts[category] || 0) + 1;
      }

      // Pretext Grouped - split on "; "
      const pretextRaw = record['pretext-grouped'] || record['Pretext Grouped'] || '';
      const pretexts = pretextRaw.split(';').map(value => value.trim()).filter(Boolean);
      pretexts.forEach(pretext => {
        if (pretext && pretext.toLowerCase() !== 'unknown') {
          pretextCounts[pretext] = (pretextCounts[pretext] || 0) + 1;
        }
      });
    });

    const categoryData = Object.entries(categoryCounts)
      .map(([name, value]) => ({ name, value }))
      .sort((a, b) => b.value - a.value);
    
    // Group pretexts with only 1 occurrence into "Other"
    const pretextEntries = Object.entries(pretextCounts);
    let otherCount = 0;
    const filteredPretexts = [];
    pretextEntries.forEach(([name, value]) => {
      if (value === 1) {
        otherCount += 1;
      } else {
        filteredPretexts.push({ name, value });
      }
    });
    if (otherCount > 0) {
      filteredPretexts.push({ name: 'Other', value: otherCount });
    }
    const pretextData = filteredPretexts.sort((a, b) => b.value - a.value);

    // Pie chart colors
    const pieColors = [
      '#F4A460', '#DEB887', '#DAA520', '#CD853F', '#D2691E', 
      '#A0522D', '#8B4513', '#BC8F8F', '#C19A6B', '#B8860B',
      '#D2B48C', '#8B7355', '#F5DEB3'
    ];

    // Create tables for pie charts
    const categoryTableRows = categoryData.map(item => [item.name, item.value.toString()]);
    createDataTable('chart-pie-category-table', ['Category', 'Count'], categoryTableRows, 'Data table for categories of violence chart');
    
    const pretextTableRows = pretextData.map(item => [item.name, item.value.toString()]);
    createDataTable('chart-pie-pretext-table', ['Pretext', 'Count'], pretextTableRows, 'Data table for pretexts for violence chart');
    
    // Category Pie Chart
    const chartPieCategory = echarts.init(document.getElementById('chart-pie-category'));
    chartPieCategory.setOption({
      tooltip: {
        trigger: 'item',
        backgroundColor: '#FDF5E6',
        borderColor: '#8B4513',
        borderWidth: 2,
        textStyle: { color: '#5D4037' },
        formatter: function(params) {
          return params.name + ': ' + params.value + ' (' + params.percent.toFixed(1) + '%)';
        }
      },
      legend: { show: false },
      color: pieColors,
      series: [
        {
          name: 'Category of Violence',
          type: 'pie',
          radius: ['25%', '70%'],
          center: ['50%', '50%'],
          label: { 
            color: '#5D4037', 
            fontSize: 11,
            formatter: '{b}: {c}'
          },
          labelLine: { lineStyle: { color: '#A0522D' } },
          emphasis: {
            itemStyle: {
              shadowBlur: 10,
              shadowOffsetX: 0,
              shadowColor: 'rgba(0, 0, 0, 0.3)'
            }
          },
          data: categoryData
        }
      ]
    });

    // Pretext Pie Chart
    const chartPiePretext = echarts.init(document.getElementById('chart-pie-pretext'));
    chartPiePretext.setOption({
      tooltip: {
        trigger: 'item',
        backgroundColor: '#FDF5E6',
        borderColor: '#8B4513',
        borderWidth: 2,
        textStyle: { color: '#5D4037' },
        formatter: function(params) {
          return params.name + ': ' + params.value + ' (' + params.percent.toFixed(1) + '%)';
        }
      },
      legend: { show: false },
      color: pieColors,
      series: [
        {
          name: 'Pretext for Violence',
          type: 'pie',
          radius: ['25%', '70%'],
          center: ['50%', '50%'],
          label: { 
            color: '#5D4037', 
            fontSize: 11,
            formatter: '{b}: {c}'
          },
          labelLine: { lineStyle: { color: '#A0522D' } },
          emphasis: {
            itemStyle: {
              shadowBlur: 10,
              shadowOffsetX: 0,
              shadowColor: 'rgba(0, 0, 0, 0.3)'
            }
          },
          data: pretextData
        }
      ]
    });

    // --- Chart 4: Combo Chart ---
    // Extract population data from timeline.json
    const censusEntries = timelineData.filter(e => e.eventType && e.eventType.toLowerCase().includes('census'));
    // Parse year and population from text
    const popData = censusEntries.map(e => {
      const match = e.text.match(/Total Asian Population: ([\d,]+)/);
      return {
        year: Number(e.year),
        population: match ? Number(match[1].replace(/,/g, '')) : null
      };
    }).filter(e => e.population !== null);
    // Interpolate population for all years 1850-1915
    const popByYear = {};
    for (let i = 0; i < popData.length - 1; i++) {
      const start = popData[i];
      const end = popData[i + 1];
      const span = end.year - start.year;
      for (let y = start.year; y < end.year; y++) {
        const t = (y - start.year) / span;
        popByYear[y] = Math.round(start.population + t * (end.population - start.population));
      }
    }
    // Fill last census year
    popByYear[popData[popData.length - 1].year] = popData[popData.length - 1].population;

    // Victims per year from lynchings data (live spreadsheet)
    const victimsByYear = {};
    lynchingsData.forEach(record => {
      let y = record.year;
      if (!y || y === 0) {
        if (record.date) {
          const dateMatch = record.date.match(/^(\d{4})/);
          if (dateMatch) {
            y = parseInt(dateMatch[1]);
          }
        }
      } else {
        y = parseInt(y);
      }
      const n = Number(record['number-of-victims']) || 0;
      if (y && !isNaN(y) && n > 0) {
        victimsByYear[y] = (victimsByYear[y] || 0) + n;
      }
    });
    // Years to plot: 1850-1915
    const comboYears = [];
    for (let y = 1850; y <= 1915; y++) comboYears.push(y);
    const victimsSeries = comboYears.map(y => victimsByYear[y] || 0);
    const popSeries = comboYears.map(y => popByYear[y] || null);
    const maxVictims = victimsSeries.reduce((max, val) => Math.max(max, val), 0);
    const labelTop = maxVictims + Math.max(3, Math.round(maxVictims * 0.15));
    const labelTopAlt = labelTop - 3;

    // Policy events with their years and labels
    const policyEvents = [
      { year: 1852, label: "Foreign Miners' Tax" },
      { year: 1882, label: 'Exclusion Act' },
      { year: 1888, label: 'Scott Act' },
      { year: 1892, label: 'Geary Act' },
      { year: 1913, label: 'CA Alien Land Law' }
    ];

    // Create table for combo chart
    const comboTableRows = comboYears.map((y, i) => [
      y.toString(),
      victimsSeries[i].toString(),
      popSeries[i] ? popSeries[i].toLocaleString() : 'N/A'
    ]);
    createDataTable('chart-combo-table', ['Year', 'Victims', 'Chinese Population'], comboTableRows, 'Data table for combination chart');
    
    const chartCombo = echarts.init(document.getElementById('chart-combo'));
    chartCombo.setOption({
      tooltip: { 
        trigger: 'axis', 
        axisPointer: { 
          type: 'cross',
          crossStyle: { color: '#8B4513' },
          lineStyle: { color: '#8B4513' },
          label: {
            formatter: function(params) {
              if (params.axisDimension === 'y' && params.axisIndex === 0) {
                return Math.round(params.value);
              }
              if (params.axisDimension === 'y' && params.axisIndex === 1) {
                return Math.round(params.value / 1000) + 'k';
              }
              return params.value;
            }
          }
        },
        backgroundColor: '#FDF5E6',
        borderColor: '#8B4513',
        borderWidth: 2,
        textStyle: { color: '#5D4037', fontSize: 13 },
        formatter: function(params) {
          var result = '<div style="font-weight:bold;margin-bottom:6px;color:#5D4037;font-size:14px;">' + params[0].axisValue + '</div>';
          for (var i = 0; i < params.length; i++) {
            var item = params[i];
            var color = item.seriesName === 'Victims' ? '#C9A0A0' : '#DAA520';
            var value;
            if (item.seriesName === 'Chinese Population') {
              value = item.value ? item.value.toLocaleString() : 'N/A';
            } else {
              value = Math.round(item.value || 0);
            }
            result += '<div style="display:flex;align-items:center;margin:4px 0;">' +
              '<span style="display:inline-block;width:12px;height:12px;background:' + color + ';border-radius:2px;margin-right:8px;border:1px solid #5D4037;"></span>' +
              '<span style="color:#5D4037;">' + item.seriesName + ': <strong style="color:#333;">' + value + '</strong></span>' +
            '</div>';
          }
          return result;
        }
      },
      legend: { 
        data: ['Victims', 'Chinese Population'], 
        bottom: 8,
        left: 'center',
        itemGap: 40,
        itemWidth: 20,
        itemHeight: 14,
        textStyle: { color: '#5D4037', fontSize: 13, fontWeight: 'bold' }
      },
      xAxis: {
        type: 'category',
        data: comboYears,
        axisLabel: { align: 'center', color: '#5D4037', fontSize: 11 },
        axisTick: { alignWithLabel: true },
        axisLine: { lineStyle: { color: '#A0522D', width: 2 } }
      },
      yAxis: [
        {
          type: 'value',
          name: 'Number of Victims',
          position: 'left',
          nameLocation: 'center',
          nameGap: 50,
          nameRotate: 90,
          nameTextStyle: { fontWeight: 'bold', fontSize: 14, fontFamily: 'sans-serif', color: '#C9A0A0' },
          axisLabel: { 
            color: '#996666', 
            fontSize: 12, 
            fontWeight: 'bold',
            formatter: function(value) {
              return value >= labelTop ? '' : Math.round(value);
            }
          },
          axisLine: { show: true, lineStyle: { color: '#C9A0A0', width: 3 } },
          max: labelTop + 2,
          splitLine: { lineStyle: { color: '#DEB887', opacity: 0.4 } }
        },
        {
          type: 'value',
          name: 'Chinese Population',
          position: 'right',
          nameLocation: 'center',
          nameGap: 55,
          nameRotate: -90,
          nameTextStyle: { fontWeight: 'bold', fontSize: 14, fontFamily: 'sans-serif', color: '#DAA520' },
          splitLine: { show: false },
          axisLabel: { 
            color: '#B8860B', 
            fontSize: 12, 
            fontWeight: 'bold',
            formatter: function(value) { 
              return value >= 1000 ? (value/1000).toFixed(0) + 'k' : value; 
            } 
          },
          axisLine: { show: true, lineStyle: { color: '#DAA520', width: 3 } }
        }
      ],
      series: [
        {
          name: 'Victims',
          type: 'bar',
          data: victimsSeries,
          yAxisIndex: 0,
          itemStyle: { 
            color: '#C9A0A0',
            borderColor: '#996666',
            borderWidth: 1,
            opacity: 0.9
          },
          barWidth: '60%',
          emphasis: {
            focus: 'series',
            itemStyle: {
              color: '#D4B5B5',
              borderColor: '#996666',
              borderWidth: 2,
              shadowBlur: 10,
              shadowColor: 'rgba(0, 0, 0, 0.3)'
            }
          },
          markLine: {
            silent: true,
            symbol: ['none', 'none'],
            lineStyle: { color: '#7A6B5A', width: 1.5, type: 'dashed' },
            label: { show: false },
            data: policyEvents.map(function(e) { return { xAxis: e.year }; })
          }
        },
        {
          name: 'Chinese Population',
          type: 'line',
          data: popSeries,
          yAxisIndex: 1,
          lineStyle: { color: '#DAA520', width: 3 },
          areaStyle: { color: '#DAA520', opacity: 0.15 },
          symbol: 'circle',
          symbolSize: 4,
          itemStyle: { color: '#DAA520', borderColor: '#B8860B', borderWidth: 1 },
          emphasis: {
            focus: 'series',
            lineStyle: { color: '#B8860B', width: 4 },
            areaStyle: { color: '#DAA520', opacity: 0.3 },
            itemStyle: {
              color: '#FFD700',
              borderColor: '#B8860B',
              borderWidth: 2
            }
          }
        }
      ],
      grid: { left: 70, right: 75, top: 70, bottom: 55 },
      responsive: true
    });

    function renderPolicyEventGraphics() {
      var graphics = policyEvents.map(function(event) {
        var useAltRow = event.year === 1882 || event.year === 1892;
        var labelValue = useAltRow ? labelTopAlt : labelTop;
        var labelPixel = chartCombo.convertToPixel({ xAxisIndex: 0, yAxisIndex: 0 }, [String(event.year), labelValue]);
        var axisPixel = chartCombo.convertToPixel({ xAxisIndex: 0, yAxisIndex: 0 }, [String(event.year), 0]);
        if (!labelPixel || !axisPixel) return null;
        return {
          type: 'group',
          silent: true,
          z: 10,
          zlevel: 2,
          children: [
            {
              type: 'line',
              shape: {
                x1: labelPixel[0],
                y1: labelPixel[1] + 4,
                x2: labelPixel[0],
                y2: axisPixel[1]
              },
              style: {
                stroke: '#7A6B5A',
                lineWidth: 1,
                lineDash: [4, 4]
              }
            },
            {
              type: 'text',
              style: {
                text: event.label,
                x: labelPixel[0],
                y: labelPixel[1] - 4,
                font: 'bold 11px sans-serif',
                fill: '#333',
                textAlign: 'center',
                textVerticalAlign: 'bottom'
              }
            }
          ]
        };
      }).filter(Boolean);
      chartCombo.setOption({ graphic: graphics });
    }

    chartCombo.on('finished', renderPolicyEventGraphics);
    renderPolicyEventGraphics();
    window.addEventListener('resize', function() {
      chartCombo.resize();
      setTimeout(renderPolicyEventGraphics, 60);
    });
  </script>
</PageLayout>