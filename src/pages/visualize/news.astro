---
import PageLayout from "../../layouts/PageLayout.astro";
import ArticleViewer from "../../components/ArticleViewer.astro";
import topNamedEntities from "../../data/top-named-entities.json";
import { fetchArticlesData } from "../../utils/googleSheets";

export const prerender = false;

// Fetch articles directly from Google Sheets

const articles = await fetchArticlesData();

// Extract unique values for dropdowns
const decades = [...new Set(articles.map((article: any) => article.decade).filter(Boolean))].sort();
const states = [...new Set(articles.map((article: any) => article.state).filter(Boolean))].sort();
const publications = [...new Set(articles.map((article: any) => article.newspaper).filter(Boolean))].sort();
const entities = [...topNamedEntities].sort(); // Alphabetize the entities
---

<PageLayout title="In the News - Visualize the Data" currentPage="visualize">
  <head>
    <meta name="description" content="Explore a searchable archive of historical newspaper articles documenting anti-Chinese violence and exclusion. Filter by decade, state, publication, or named entities to discover contemporary perspectives on these events.">
  </head>
  <div class="container-wide">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="Breadcrumb" class="mb-4">
      <ol class="flex items-center text-sm flex-wrap">
        <li class="flex items-center">
          <a href="/" class="text-gray-700 hover:text-accent hover:underline transition-colors">Home</a>
          <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </li>
        <li class="flex items-center">
          <a href="/visualize" class="text-gray-700 hover:text-accent hover:underline transition-colors">Visualize the Data</a>
          <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </li>
        <li class="text-gray-500 font-normal truncate max-w-xs" aria-current="page">
          In the News
        </li>
      </ol>
    </nav>
    <div class="mb-6">
      <h1 class="text-4xl font-bold mb-2">Newspaper Archive</h1>
      <p class="text-lg text-gray-600 mb-6">
        Explore historical newspaper articles documenting events and patterns in our dataset. 
        Filter by decade, state, publication, or named entities to discover contemporary perspectives.
      </p>
    </div>

    <!-- Filter and Sort Controls -->
    <div class="bg-amber-50/90 border-2 border-amber-200 rounded-lg p-4 mb-6 shadow-lg">
      <!-- Keyword Search Panel - At Top -->
      <div class="mb-4">
        <div class="bg-white rounded-lg p-3 border border-amber-300 flex items-center gap-4">
          <label for="keyword-search" class="font-medium text-vintage-ink whitespace-nowrap">Keyword Search:</label>
          <input id="keyword-search" type="text" class="input input-bordered border-2 border-amber-300 bg-amber-50 flex-1" placeholder="Search titles, summaries, transcripts, years (e.g. 1873)..." aria-describedby="keyword-search-hint" />
          <span id="keyword-search-hint" class="sr-only">Search article titles, summaries, transcripts, newspaper names, locations, publication dates and years (e.g. 1873), citations, and record IDs</span>
          <button id="keyword-clear" class="px-4 py-2 bg-amber-100 hover:bg-amber-200 text-vintage-ink font-medium rounded-md shadow-sm hover:shadow-md transition-all duration-200 border border-amber-300 hover:border-amber-400 text-sm whitespace-nowrap" aria-label="Clear keyword search">Clear</button>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Filter Section -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-lg p-3 border border-amber-300">
            <h3 class="text-lg font-semibold mb-3 text-vintage-ink border-b border-amber-200 pb-2">Filters</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium text-vintage-ink">Decade</span>
                </label>
                <select id="filter-decade" class="select select-bordered w-full border-2 border-amber-300 bg-amber-50">
                  <option value="">All Decades</option>
                  {decades.map(decade => <option value={decade}>{decade}</option>)}
                </select>
              </div>
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium text-amber-800">Publication State or Country</span>
                </label>
                <select id="filter-state" class="select select-bordered w-full border-2 border-amber-300 bg-amber-50">
                  <option value="">All Locations</option>
                  {states.map(state => <option value={state}>{state}</option>)}
                </select>
              </div>
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium text-amber-800">Publication Title</span>
                </label>
                <select id="filter-publication" class="select select-bordered w-full border-2 border-amber-300 bg-amber-50">
                  <option value="">All Publications</option>
                  {publications.map(pub => <option value={pub}>{pub}</option>)}
                </select>
              </div>
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium text-amber-800">Top Named Entities</span>
                </label>
                <select id="filter-entities" class="select select-bordered w-full border-2 border-amber-300 bg-amber-50">
                  <option value="">All Entities</option>
                  {entities.map(entity => <option value={entity}>{entity}</option>)}
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Sort Section - Compact -->
        <div>
          <div class="bg-white rounded-lg p-3 border border-amber-300 h-full">
            <h3 class="text-lg font-semibold mb-3 text-vintage-ink border-b border-amber-200 pb-2">Sort Options</h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="form-control">
                <label class="label py-1">
                  <span class="label-text font-medium text-amber-800">Sort By</span>
                </label>
                <select id="sort-by" class="select select-bordered w-full border-2 border-amber-300 bg-amber-50 select-sm">
                  <option value="date">Date</option>
                  <option value="state">State</option>
                  <option value="title">Title</option>
                  <option value="newspaper">Newspaper</option>
                </select>
              </div>
              <div class="form-control">
                <label class="label py-1">
                  <span class="label-text font-medium text-amber-800">Order</span>
                </label>
                <select id="sort-order" class="select select-bordered w-full border-2 border-amber-300 bg-amber-50 select-sm">
                  <option value="asc">Ascending</option>
                  <option value="desc">Descending</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="mt-3 flex justify-between items-center">
        <div class="text-sm text-vintage-ink bg-amber-100 rounded-lg p-2 flex-1 text-center">
          <span id="results-count">Showing all {articles.length} articles</span>
        </div>
        <button id="clear-filters" class="ml-4 px-4 py-2 bg-amber-100 hover:bg-amber-200 text-vintage-ink font-medium rounded-md shadow-sm hover:shadow-md transition-all duration-200 border border-amber-300 hover:border-amber-400 flex items-center gap-2 text-sm" aria-label="Clear all filters and show all articles">
          Clear All Filters
        </button>
      </div>
    </div>

    <!-- ARIA live region for dynamic announcements -->
    <div id="results-announcement" aria-live="polite" aria-atomic="true" class="sr-only"></div>

    <!-- Article Cards Grid -->
    <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" aria-label="Newspaper articles"></div>

    <!-- Article Viewer Component -->
    <ArticleViewer />

    <!-- Loading State -->
    <div id="loading" class="hidden text-center py-12">
      <div class="loading loading-spinner loading-lg"></div>
      <p class="mt-4 text-gray-600">Loading articles...</p>
    </div>

    <!-- No Results State -->
    <div id="no-results" class="hidden text-center py-12">
      <div class="text-gray-400 mb-4">
        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
      </div>
      <h3 class="text-xl font-semibold mb-2">No articles found</h3>
      <p class="text-gray-600 mb-4">Try adjusting your filters or clearing them to see all articles.</p>
      <button id="reset-filters" class="btn btn-outline">Show All Articles</button>
    </div>
  </div>

  <script define:vars={{ articles, entities }}>
    const container = document.getElementById('cards-container');
    const decadeInput = document.getElementById('filter-decade');
    const stateInput = document.getElementById('filter-state');
    const publicationInput = document.getElementById('filter-publication');
    const entitiesInput = document.getElementById('filter-entities');
    const sortByInput = document.getElementById('sort-by');
    const sortOrderInput = document.getElementById('sort-order');
    const clearBtn = document.getElementById('clear-filters');
    const keywordInput = document.getElementById('keyword-search');
    const keywordClearBtn = document.getElementById('keyword-clear');
    
    const resultsCount = document.getElementById('results-count');
    const loading = document.getElementById('loading');
    const noResults = document.getElementById('no-results');
    
    let lastKeyword = '';
    



    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }

    function renderCards(filtered) {
      container.innerHTML = '';
      const announcementEl = document.getElementById('results-announcement');
      
      if (filtered.length === 0) {
        container.classList.add('hidden');
        noResults.classList.remove('hidden');
        resultsCount.textContent = 'No articles found';
        if (announcementEl) {
          announcementEl.textContent = 'No articles found matching your filters.';
          setTimeout(() => announcementEl.textContent = '', 1000);
        }
        return;
      }

      container.classList.remove('hidden');
      noResults.classList.add('hidden');
      const message = `Showing ${filtered.length} of ${articles.length} articles`;
      resultsCount.textContent = message;
      if (announcementEl) {
        announcementEl.textContent = message;
        setTimeout(() => announcementEl.textContent = '', 1000);
      }

      filtered.forEach((article, index) => {
        const card = document.createElement('div');
        card.className = 'card bg-base-100 shadow-md hover:shadow-lg transition-shadow cursor-pointer border border-base-300';
        card.innerHTML = `
          <div class="card-body p-4">
            <div class="flex justify-between items-start mb-3">
              <h3 class="card-title text-base font-semibold line-clamp-3 flex-1 mr-3">${article['article-title'] || 'Untitled'}</h3>
              <span class="badge badge-primary badge-sm flex-shrink-0">${article['publication-year'] || 'Unknown'}</span>
            </div>
            <p class="text-sm text-gray-600 mb-2">
              <span class="font-medium">${article.newspaper || 'Unknown Publication'}</span>${article['newspaper-location'] ? ` (${article['newspaper-location']})` : ''}
            </p>
            <p class="text-sm text-gray-500 mb-3">
              ${formatDate(article['publication-date'])}${article.page ? ` (Page ${article.page})` : ''}
            </p>
            <div class="summary-container relative">
              <p class="text-sm text-gray-700 summary-text">${article['article-summary'] || 'No summary available.'}</p>
              <div class="summary-fade"></div>
            </div>
          </div>
        `;
        
        card.addEventListener('click', () => renderViewer(article));
        container.appendChild(card);
      });
    }



    function renderViewer(article) {
      // Create title with newspaper metadata (without location since it's in citation)
      const newspaperName = article.newspaper || 'Unknown Publication';
      const publicationDate = formatDate(article['publication-date']);
      const titleWithMetadata = `${article['article-title'] || 'Untitled Article'} - ${newspaperName}, ${publicationDate}`;
      
      // Set image with fallback
      const imagePath = `/article-scans/${article.image_name}`;
      
      // Transcription with proper formatting
      const transcript = (article['article-transcript'] || 'No transcription available.')
        .replace(/⏎/g, '\n')
        .split(/\n/)
        .map(paragraph => paragraph.trim())
        .filter(paragraph => paragraph.length > 0);
      const formattedTranscript = transcript.map((p, index) => {
        return `<p class='leading-relaxed'>${p}</p>`;
      }).join('');
      
      // Use the new component's API
      if (window.articleViewer) {
        window.articleViewer.show({
          title: titleWithMetadata,
          imageUrl: imagePath,
          transcription: formattedTranscript,
          citation: article['turabian-citation'] || 'Citation not available.'
        });
      }
    }



    function applyFilters() {
      const decade = decadeInput.value;
      const state = stateInput.value;
      const publication = publicationInput.value;
      const entityFilter = entitiesInput.value;
      const keyword = (keywordInput?.value || '').trim().replace(/\s+/g, ' ').toLowerCase();
      lastKeyword = keyword;
      
      const filtered = articles.filter(article => {
        const decadeMatch = !decade || article.decade === decade;
        const stateMatch = !state || article.state === state;
        const publicationMatch = !publication || article.newspaper === publication;
        const entitiesMatch = !entityFilter || (article['named-entities'] && article['named-entities'].toLowerCase().includes(entityFilter.toLowerCase()));
        
        // Keyword search across title, summary, transcript, newspaper, location, dates, citation, lynching-id
        let keywordMatch = true;
        if (keyword) {
          const title = (article['article-title'] || '').toLowerCase();
          const summary = (article['article-summary'] || '').toLowerCase();
          const transcript = (article['article-transcript'] || '').toLowerCase();
          const newspaper = (article.newspaper || '').toLowerCase();
          const location = (article['newspaper-location'] || '').toLowerCase();
          const pubDate = (article['publication-date'] || '').toLowerCase();
          const pubDateExpanded = (article['publication-date-expanded'] || '').toLowerCase();
          const pubYear = String(article['publication-year'] ?? '').toLowerCase();
          const citation = (article['turabian-citation'] || '').toLowerCase();
          const lynchingId = (article['lynching-id'] || '').toLowerCase();
          
          keywordMatch = title.includes(keyword) ||
                        summary.includes(keyword) ||
                        transcript.includes(keyword) ||
                        newspaper.includes(keyword) ||
                        location.includes(keyword) ||
                        pubDate.includes(keyword) ||
                        pubDateExpanded.includes(keyword) ||
                        pubYear.includes(keyword) ||
                        citation.includes(keyword) ||
                        lynchingId.includes(keyword);
        }
        
        return decadeMatch && stateMatch && publicationMatch && entitiesMatch && keywordMatch;
      });
      
      // Update filter options based on current selection
      updateFilterOptions();
      
      // Sort the filtered results
      const sorted = sortArticles(filtered);
      renderCards(sorted);
    }

    function updateFilterOptions() {
      // Get current filter values
      const decade = decadeInput.value;
      const state = stateInput.value;
      const publication = publicationInput.value;
      const entityFilter = entitiesInput.value;
      const keyword = (keywordInput?.value || '').trim().replace(/\s+/g, ' ').toLowerCase();
      
      // Count how many dropdown filters are active (not including keyword)
      const activeDropdownCount = [decade, state, publication, entityFilter].filter(Boolean).length;
      
      // Helper to filter articles by keyword (searches ENTIRE dataset, ignoring dropdown filters)
      const keywordFilteredArticles = keyword ? articles.filter(article => {
        const title = (article['article-title'] || '').toLowerCase();
        const summary = (article['article-summary'] || '').toLowerCase();
        const transcript = (article['article-transcript'] || '').toLowerCase();
        const newspaper = (article.newspaper || '').toLowerCase();
        const location = (article['newspaper-location'] || '').toLowerCase();
        const pubDate = (article['publication-date'] || '').toLowerCase();
        const pubDateExpanded = (article['publication-date-expanded'] || '').toLowerCase();
        const pubYear = String(article['publication-year'] ?? '').toLowerCase();
        const citation = (article['turabian-citation'] || '').toLowerCase();
        const lynchingId = (article['lynching-id'] || '').toLowerCase();
        return title.includes(keyword) || summary.includes(keyword) ||
               transcript.includes(keyword) || newspaper.includes(keyword) || location.includes(keyword) ||
               pubDate.includes(keyword) || pubDateExpanded.includes(keyword) || pubYear.includes(keyword) ||
               citation.includes(keyword) || lynchingId.includes(keyword);
      }) : articles;
      
      // RULE: Filter ALL dropdowns if keyword is present OR 2+ dropdowns are selected
      // Otherwise (0-1 dropdown, no keyword): selected dropdown keeps all values, others filter
      const filterAllDropdowns = keyword || activeDropdownCount >= 2;
      
      let availableDecades, availableStates, availablePublications, availableEntities;
      
      if (filterAllDropdowns) {
        // ALL dropdowns get filtered based on other selections within keyword-filtered set
        
        // DECADE: filter by state, publication, entity (within keyword results)
        const decadeBase = keywordFilteredArticles.filter(article => {
          const stateMatch = !state || article.state === state;
          const publicationMatch = !publication || article.newspaper === publication;
          const entitiesMatch = !entityFilter || (article['named-entities'] && article['named-entities'].toLowerCase().includes(entityFilter.toLowerCase()));
          return stateMatch && publicationMatch && entitiesMatch;
        });
        availableDecades = [...new Set(decadeBase.map(a => a.decade).filter(Boolean))];
        
        // STATE: filter by decade, publication, entity (within keyword results)
        const stateBase = keywordFilteredArticles.filter(article => {
          const decadeMatch = !decade || article.decade === decade;
          const publicationMatch = !publication || article.newspaper === publication;
          const entitiesMatch = !entityFilter || (article['named-entities'] && article['named-entities'].toLowerCase().includes(entityFilter.toLowerCase()));
          return decadeMatch && publicationMatch && entitiesMatch;
        });
        availableStates = [...new Set(stateBase.map(a => a.state).filter(Boolean))];
        
        // PUBLICATION: filter by decade, state, entity (within keyword results)
        const publicationBase = keywordFilteredArticles.filter(article => {
          const decadeMatch = !decade || article.decade === decade;
          const stateMatch = !state || article.state === state;
          const entitiesMatch = !entityFilter || (article['named-entities'] && article['named-entities'].toLowerCase().includes(entityFilter.toLowerCase()));
          return decadeMatch && stateMatch && entitiesMatch;
        });
        availablePublications = [...new Set(publicationBase.map(a => a.newspaper).filter(Boolean))];
        
        // ENTITIES: filter by decade, state, publication (within keyword results)
        const entitiesBase = keywordFilteredArticles.filter(article => {
          const decadeMatch = !decade || article.decade === decade;
          const stateMatch = !state || article.state === state;
          const publicationMatch = !publication || article.newspaper === publication;
          return decadeMatch && stateMatch && publicationMatch;
        });
        availableEntities = [...new Set(entitiesBase.flatMap(a => 
          a['named-entities'] ? a['named-entities'].split('@') : []
        ).filter(Boolean).filter(e => e !== 'nan' && e !== 'NaN' && entities.includes(e)))];
        
      } else if (activeDropdownCount === 1) {
        // Only 1 dropdown selected (no keyword): that dropdown keeps ALL values, others filter
        
        if (decade) {
          // Decade is selected - it keeps all values, others filter by decade
          availableDecades = [...new Set(articles.map(a => a.decade).filter(Boolean))];
          const filtered = articles.filter(a => a.decade === decade);
          availableStates = [...new Set(filtered.map(a => a.state).filter(Boolean))];
          availablePublications = [...new Set(filtered.map(a => a.newspaper).filter(Boolean))];
          availableEntities = [...new Set(filtered.flatMap(a => 
            a['named-entities'] ? a['named-entities'].split('@') : []
          ).filter(Boolean).filter(e => e !== 'nan' && e !== 'NaN' && entities.includes(e)))];
        } else if (state) {
          // State is selected
          const filtered = articles.filter(a => a.state === state);
          availableDecades = [...new Set(filtered.map(a => a.decade).filter(Boolean))];
          availableStates = [...new Set(articles.map(a => a.state).filter(Boolean))];
          availablePublications = [...new Set(filtered.map(a => a.newspaper).filter(Boolean))];
          availableEntities = [...new Set(filtered.flatMap(a => 
            a['named-entities'] ? a['named-entities'].split('@') : []
          ).filter(Boolean).filter(e => e !== 'nan' && e !== 'NaN' && entities.includes(e)))];
        } else if (publication) {
          // Publication is selected
          const filtered = articles.filter(a => a.newspaper === publication);
          availableDecades = [...new Set(filtered.map(a => a.decade).filter(Boolean))];
          availableStates = [...new Set(filtered.map(a => a.state).filter(Boolean))];
          availablePublications = [...new Set(articles.map(a => a.newspaper).filter(Boolean))];
          availableEntities = [...new Set(filtered.flatMap(a => 
            a['named-entities'] ? a['named-entities'].split('@') : []
          ).filter(Boolean).filter(e => e !== 'nan' && e !== 'NaN' && entities.includes(e)))];
        } else if (entityFilter) {
          // Entity is selected
          const filtered = articles.filter(a => a['named-entities'] && a['named-entities'].toLowerCase().includes(entityFilter.toLowerCase()));
          availableDecades = [...new Set(filtered.map(a => a.decade).filter(Boolean))];
          availableStates = [...new Set(filtered.map(a => a.state).filter(Boolean))];
          availablePublications = [...new Set(filtered.map(a => a.newspaper).filter(Boolean))];
          availableEntities = entities.slice(); // All entities
        }
      } else {
        // No filters at all - all values available
        availableDecades = [...new Set(articles.map(a => a.decade).filter(Boolean))];
        availableStates = [...new Set(articles.map(a => a.state).filter(Boolean))];
        availablePublications = [...new Set(articles.map(a => a.newspaper).filter(Boolean))];
        availableEntities = entities.slice();
      }

      // Update all dropdown options (with enabled values sorted to top)
      updateSelectOptions(decadeInput, availableDecades, 'All Decades');
      updateSelectOptions(stateInput, availableStates, 'All Locations');
      updateSelectOptions(publicationInput, availablePublications, 'All Publications');
      updateSelectOptions(entitiesInput, availableEntities, 'All Entities');
    }

    function updateSelectOptions(selectElement, availableValues, defaultText) {
      const currentValue = selectElement.value;
      
      // Clear existing options
      selectElement.innerHTML = `<option value="">${defaultText}</option>`;
      
      // Get all possible values for this filter
      const allValues = getFilterValues(selectElement.id);
      
      // Separate enabled and disabled values
      const enabledValues = [];
      const disabledValues = [];
      
      allValues.forEach(value => {
        if (availableValues.includes(value)) {
          enabledValues.push(value);
        } else {
          disabledValues.push(value);
        }
      });
      
      // Sort enabled values alphabetically, then disabled values alphabetically
      enabledValues.sort();
      disabledValues.sort();
      
      // Add enabled values first (at top for easy access)
      enabledValues.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        selectElement.appendChild(option);
      });
      
      // Add separator if there are both enabled and disabled values
      if (enabledValues.length > 0 && disabledValues.length > 0) {
        const separator = document.createElement('option');
        separator.disabled = true;
        separator.textContent = '───────────────';
        separator.className = 'text-gray-300';
        selectElement.appendChild(separator);
      }
      
      // Add disabled values at the bottom
      disabledValues.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        option.disabled = true;
        option.className = 'text-gray-400';
        selectElement.appendChild(option);
      });
      
      // Restore current value
      if (currentValue) {
        selectElement.value = currentValue;
      }
    }

    function getFilterValues(filterId) {
      switch (filterId) {
        case 'filter-decade':
          return [...new Set(articles.map(article => article.decade).filter(Boolean))].sort();
        case 'filter-state':
          return [...new Set(articles.map(article => article.state).filter(Boolean))].sort();
        case 'filter-publication':
          return [...new Set(articles.map(article => article.newspaper).filter(Boolean))].sort();
        case 'filter-entities':
          return entities;
        default:
          return [];
      }
    }

    function sortArticles(articlesToSort) {
      const sortBy = sortByInput.value;
      const sortOrder = sortOrderInput.value;
      
      return [...articlesToSort].sort((a, b) => {
        let aValue, bValue;
        
        switch (sortBy) {
          case 'date':
            aValue = a['publication-date'] || '';
            bValue = b['publication-date'] || '';
            break;
          case 'state':
            aValue = a.state || '';
            bValue = b.state || '';
            break;
          case 'title':
            aValue = a['article-title'] || '';
            bValue = b['article-title'] || '';
            break;
          case 'newspaper':
            aValue = a.newspaper || '';
            bValue = b.newspaper || '';
            break;
          default:
            aValue = a['publication-date'] || '';
            bValue = b['publication-date'] || '';
        }
        
        // Handle date comparison
        if (sortBy === 'date') {
          const dateA = new Date(aValue);
          const dateB = new Date(bValue);
          return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
        }
        
        // Handle string comparison
        const comparison = aValue.localeCompare(bValue);
        return sortOrder === 'asc' ? comparison : -comparison;
      });
    }

    function clearAllFilters() {
      decadeInput.value = '';
      stateInput.value = '';
      publicationInput.value = '';
      entitiesInput.value = '';
      sortByInput.value = 'date';
      sortOrderInput.value = 'asc';
      if (keywordInput) keywordInput.value = '';
      lastKeyword = '';
      
      // Reset all filter options and show all articles
      updateFilterOptions();
      renderCards(sortArticles(articles));
    }

    // Event listeners
    decadeInput.addEventListener('change', applyFilters);
    stateInput.addEventListener('change', applyFilters);
    publicationInput.addEventListener('change', applyFilters);
    entitiesInput.addEventListener('change', applyFilters);
    sortByInput.addEventListener('change', applyFilters);
    sortOrderInput.addEventListener('change', applyFilters);
    clearBtn.addEventListener('click', clearAllFilters);
    
    // Keyword search event listeners
    if (keywordInput) {
      keywordInput.addEventListener('input', (e) => {
        const newKeyword = (e.target.value || '').trim().replace(/\s+/g, ' ').toLowerCase();
        if (newKeyword !== lastKeyword) {
          applyFilters();
        }
      });
    }
    
    if (keywordClearBtn) {
      keywordClearBtn.addEventListener('click', () => {
        if (keywordInput) keywordInput.value = '';
        lastKeyword = '';
        applyFilters();
      });
    }

    // Initialize with sorted articles and set up filter options
    updateFilterOptions();
    renderCards(sortArticles(articles));
  </script>

  <style>
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .line-clamp-4 {
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .line-clamp-5 {
      display: -webkit-box;
      -webkit-line-clamp: 5;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .summary-container {
      max-height: 120px;
      overflow: hidden;
    }

    .summary-text {
      margin-bottom: 0;
    }

    .summary-fade {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: linear-gradient(transparent, white);
      pointer-events: none;
    }

    .bg-newspaper-offwhite {
      background-color: #faf9f6;
    }



    /* Style disabled options */
    select option:disabled {
      color: #9ca3af;
      font-style: italic;
    }

    @media (max-width: 1024px) {
      .article-viewer-flex {
        flex-direction: column;
      }
      .article-viewer-flex > div {
        width: 100% !important;
        max-width: 100% !important;
      }
    }
  </style>
</PageLayout> 